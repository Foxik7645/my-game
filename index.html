<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Map Game ‚Äî Firebase multiplayer</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<!-- –ü–∏–∫—Å–µ–ª—å–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã (–ø–æ –∂–µ–ª–∞–Ω–∏—é UI) -->
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">

<style>
  :root{
    --cream:#F5E6C8; --accent:#ffd56a; --bar:#66e089;
    /* –ë–∞–∑–∞ –¥–ª—è HUD-—Å—Ü–µ–Ω—ã (–∫–∞–∫ –≤ —Ç–≤–æ—ë–º ¬´–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–∏¬ª) */
    --base-w: 2560;
    --base-h: 1440;
    --scale: 1;
    --bg: transparent; /* —Ñ–æ–Ω letterbox –ø–æ–¥ HUD; –æ—Å—Ç–∞–≤–∏–ª –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º */
  }
  html, body {height:100%; margin:0; background:#1e1e1e; color:#eee; font-family:'Segoe UI',sans-serif;}
  #map {position:absolute; inset:0;}

  /* ===== HUD-Overaly (—Å–ø—Ä–∞–π—Ç—ã) ===== */
  .hud-stage{
    position:fixed; left:50%; top:50%;
    width: calc(var(--base-w) * 1px);
    height: calc(var(--base-h) * 1px);
    transform: translate(-50%, -50%) scale(var(--scale));
    transform-origin: 0 0;
    image-rendering: pixelated; image-rendering: crisp-edges;
    pointer-events:none; /* –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–ª–∏–∫–æ–≤ –Ω–µ—Ç, –≤–∫–ª—é—á–∏–º —Ç–æ—á–µ—á–Ω–æ –Ω–∞ —Å–ø—Ä–∞–π—Ç–∞—Ö */
    z-index:3000; /* –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç—ã –∏ –ø–æ–ø–∞–ø–æ–≤ */
  }
  .hud-layer{ position:absolute; inset:0; }
  .sprite{
    position:absolute; display:block;
    user-select:none; -webkit-user-drag:none;
    pointer-events:auto; /* –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã —Å–∞–º–∏ —Å–ø—Ä–∞–π—Ç—ã */
  }
  .btn{ outline:none; }
  .btn:focus-visible{ box-shadow:0 0 0 3px rgba(255,220,100,.9); border-radius:8px; }

  /* ===== –ò–≥—Ä–æ–≤—ã–µ UI-—ç–ª–µ–º–µ–Ω—Ç—ã (–æ—Å—Ç–∞–≤–ª–µ–Ω—ã, —Ç.–∫. –ª–æ–≥–∏–∫–∞ –Ω–∞ –Ω–∏—Ö –æ–ø–∏—Ä–∞–µ—Ç—Å—è) ===== */
  .pixel {font-family:'Press Start 2P','VT323',monospace;}
  .leaflet-marker-icon, .leaflet-div-icon img {image-rendering: pixelated !important;}
  .marker-selected {filter: drop-shadow(0 0 6px rgba(0,255,255,.8));}
  .progress-wrap {background:rgba(0,0,0,.6); border:1px solid #777; width:64px; height:8px; border-radius:10px; overflow:hidden; transform: translate(-50%,-130%);}
  .progress-bar {height:100%; width:0%; background:var(--bar);}
  .worker {width:48px; height:48px; transform: translate(-50%, -50%);}
  .worker img {width:48px; height:48px;}
  .flip-x {transform: scaleX(-1);}
  #toasts {position:fixed; right:12px; bottom:12px; display:flex; flex-direction:column; gap:8px; z-index:3500;}
  .toast {background:#2d2b2d; border:1px solid #444; border-radius:10px; padding:10px 12px; box-shadow:0 8px 24px rgba(0,0,0,.35); min-width:280px;}
  .toast .actions {margin-top:8px; display:flex; gap:8px; justify-content:flex-end;}
  .is-hidden {opacity:0; pointer-events:none;}

  /* –ü—Ä–æ—Ñ–∏–ª—å */
  #profileOverlay, #overlay {position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; z-index:3200;}
  #profileMenu{
    position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
    background:#2b2b2b; border:1px solid #444; border-radius:12px; padding:16px; width:320px; z-index:3300;
    box-shadow:0 12px 28px rgba(0,0,0,.4); display:none;
  }
  #profileMenu .avatar-preview{width:80px; height:80px; border-radius:50%; background:#444; background-size:cover; background-position:center; margin:0 auto 10px;}
  #profileMenu .row{display:flex; flex-direction:column; gap:6px; margin:8px 0;}
  #profileMenu .actions{display:flex; justify-content:flex-end; gap:8px; margin-top:12px;}

  /* –†–µ–¥–∞–∫—Ç–æ—Ä —Å–ø—Ä–∞–π—Ç–∞ */
  #editMenu {position:fixed; top:96px; right:10px; background:#2b2b2b; padding:12px; border-radius:12px; display:none; flex-direction:column; gap:8px; z-index:3300; width:340px; box-shadow:0 8px 24px rgba(0,0,0,.35);}
  #paintCanvas {image-rendering:pixelated; border:1px solid #555; background:#000; width:480px; height:480px; align-self:center;}
  .colorPalette {display:flex; flex-wrap:wrap; gap:4px; margin-top:4px;}
  .colorTile {width:18px; height:18px; cursor:pointer; border:1px solid #555;}
  #canvasInfo {color:#aaa; font-size:12px;}

  /* –†—ã–Ω–æ–∫ */
  #marketMenu{
    position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
    background:#2b2b2b; border:1px solid #444; border-radius:12px; padding:16px; width:560px; max-width:95vw; z-index:3300;
    box-shadow:0 12px 28px rgba(0,0,0,.4); display:none;
  }
  .row {display:flex; align-items:center; justify-content:space-between; gap:10px; margin:8px 0;}
  .tag {background:#1a1a1a; border:1px solid #3a3a3a; border-radius:8px; padding:6px 10px;}
  .seg {display:flex; gap:6px; align-items:center;}
  .tabs {display:flex; gap:8px; margin-bottom:8px;}
  .tabs button {background:#333; color:#eee; border:none; padding:6px 10px; border-radius:8px; cursor:pointer;}
  .tabs .active {background:#555}

  /* –ú–∞–≥–∞–∑–∏–Ω (–ø–∞–Ω–µ–ª—å —Å–ª–µ–≤–∞, –æ—Å—Ç–∞—ë—Ç—Å—è —Å–∫—Ä—ã—Ç–∞—è, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ btn1) */
  #shopPanel{position:fixed; top:20px; left:0; bottom:20px; width:330px; background:#222; border-right:1px solid #3a3a3a; z-index:3250; display:none; overflow-y:auto; padding:12px; box-shadow:8px 0 20px rgba(0,0,0,.35);}
  #shopHeader{display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;}
  .card{position:relative; width:300px; height:438px; margin:10px auto; image-rendering:pixelated; border-radius:12px; box-shadow:0 10px 18px rgba(0,0,0,.35); cursor:pointer; overflow:hidden;}
  .card.drov {background:url('./images/CardDrovosek.png') center/cover no-repeat;}
  .card.miner {background:url('./images/CardMiner.png') center/cover no-repeat;}
  .card.base {background:url('./images/CardBase.png') center/cover no-repeat;}
  .card.fermer {background:url('./images/Cardeda.png') center/cover no-repeat;}
  .card.houseeat {background:url('./images/CardHouseEat.png') center/cover no-repeat;}
  .card.soldat {background:url('./images/CardSoldat.png') center/cover no-repeat;}
  .card .title{position:absolute; top:18px; left:84px; right:16px; font-size:13px; color:var(--cream); text-shadow:0 1px 0 #000;}
  .card .cost {position:absolute; top:46px; left:84px; right:16px; font-size:12px; color:var(--cream); text-shadow:0 1px 0 #000;}
  .card .desc {position:absolute; left:30px; right:30px; bottom:22px; font-size:12px; line-height:1.25; color:var(--cream); text-shadow:0 1px 0 #000;}
  .card .buybar{position:absolute; top:0; left:0; right:0; height:60px; z-index:3; background:linear-gradient(#2b2b2b,#1e1e1e); border-bottom:1px solid #555; display:flex; align-items:center; justify-content:center; gap:10px; transform:translateY(-100%); transition:transform .25s ease;}
  .card.active .buybar{transform:translateY(0);}
  .buybar .price{font-size:12px; color:var(--accent)}
  .card:hover{filter:brightness(1.07);}
</style>
</head>
<body>

<!-- –ö–∞—Ä—Ç–∞ -->
<div id="map"></div>

<!-- ===== HUD –∏–∑ —Å–ø—Ä–∞–π—Ç–æ–≤ (–ø–æ–∑–∏—Ü–∏–∏ –∏–∑ —Ç–≤–æ–µ–≥–æ ¬´–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ¬ª –∫–æ–¥–∞ –¥–ª—è 2560√ó1440) ===== -->
<div class="hud-stage" id="hudStage" aria-hidden="false">
  <div class="hud-layer" id="hud">
    <!-- HUD: x84 y926 -->
    <img src="images/HUD.png" alt="HUD" class="sprite" id="hudMain" style="left:84px; top:1100px;" />

    <!-- botton1: x1386 y986 -->
    <img src="images/botton1.png" alt="–ö–Ω–æ–ø–∫–∞ 1" class="sprite btn" id="btn1" style="left:1386px; top:1160px;" tabindex="0"/>

    <!-- botton2: x1524 y986 -->
    <img src="images/botton2.png" alt="–ö–Ω–æ–ø–∫–∞ 2" class="sprite btn" id="btn2" style="left:1524px; top:1160px;" tabindex="0"/>

    <!-- botton3: x102 y982 -->
    <img src="images/botton3.png" alt="–ö–Ω–æ–ø–∫–∞ 3" class="sprite btn" id="btn3" style="left:102px; top:1155px;" tabindex="0"/>

    <!-- botton4: x1728 y986 -->
    <img src="images/botton4.png" alt="–ö–Ω–æ–ø–∫–∞ 4" class="sprite btn" id="btn4" style="left:1728px; top:1160px;" tabindex="0"/>
  </div>
</div>

<!-- ===== –û–≤–µ—Ä–ª–µ–∏ –∏ –æ–∫–Ω–∞ (–∫–∞–∫ –≤ —Ç–≤–æ—ë–º –∫–æ–¥–µ) ===== -->
<div id="editMenu">
  <h4>–†–µ–¥–∞–∫—Ç–æ—Ä —Å–ø—Ä–∞–π—Ç–∞</h4>
  <canvas id="paintCanvas" width="60" height="60"></canvas>
  <div id="canvasInfo">–õ–æ–≥–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ: 60√ó60</div>
  <div class="colorPalette" id="palette"></div>
  <div style="display:flex; gap:8px; justify-content:flex-end;">
    <button id="saveSprite">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button id="closeEditor">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<div id="overlay" style="display:none"></div>
<div id="marketMenu" style="display:none">
  <h3>–†—ã–Ω–æ–∫</h3>
  <div class="tabs">
    <button id="tabWood" class="active">ü™µ –î–µ—Ä–µ–≤–æ</button>
    <button id="tabStone">ü™® –ö–∞–º–µ–Ω—å</button>
    <button id="tabCorn">üåΩ –ö—É–∫—É—Ä—É–∑–∞</button>
  </div>
  <div class="row">
    <div>–ö—É—Ä—Å: <span id="m-rate" class="tag">10 ü™µ = 50 üí∞</span></div>
    <div>–£ –≤–∞—Å: <span id="m-have" class="num">0</span></div>
  </div>
  <div class="row">
    <div>–ü—Ä–æ–¥–∞—Ç—å –Ω–∞–±–æ—Ä–æ–≤ (–ø–æ 10):</div>
    <div class="seg">
      <button id="m-dec">‚àí1</button>
      <span id="m-packs" class="tag num" style="min-width:48px;text-align:center">0</span>
      <button id="m-inc">+1</button>
      <button id="m-max">MAX</button>
    </div>
  </div>
  <div class="row">
    <div>–ü–æ–ª—É—á–∏—Ç–µ:</div>
    <div><b id="m-get" class="num">0</b> üí∞</div>
  </div>
  <div class="actions">
    <button id="m-cancel">–û—Ç–º–µ–Ω–∞</button>
    <button id="m-sell">–ü—Ä–æ–¥–∞—Ç—å</button>
    <button id="m-sell-all">–ü—Ä–æ–¥–∞—Ç—å –≤—Å—ë</button>
  </div>
</div>

<div id="profileOverlay" style="display:none"></div>
<div id="profileMenu" style="display:none">
  <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
  <div id="profileAvatar" class="avatar-preview"></div>
  <div class="row">
    <input type="file" id="avatarInput" accept="image/*"/>
  </div>
  <div class="row">
    <label for="profileName">–ù–∏–∫:</label>
    <input type="text" id="profileName"/>
  </div>
  <div class="row">ID: <span id="profileId"></span></div>
  <div class="actions">
    <button id="profileCancel">–û—Ç–º–µ–Ω–∞</button>
    <button id="profileSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>

<!-- –ú–∞–≥–∞–∑–∏–Ω (–ø–∞–Ω–µ–ª—å) -->
<aside id="shopPanel">
  <div id="shopHeader">
    <h3 class="pixel">–ú–∞–≥–∞–∑–∏–Ω</h3>
    <button id="shopClose">√ó</button>
  </div>
  <div class="card drov pixel" data-type="drovosekdom" data-cost="100" data-icon="./images/DrovosekDom.png" data-name="DrovosekDom">
    <div class="buybar"><span class="price">100 üí∞</span><button class="buyBtn">–ö—É–ø–∏—Ç—å</button></div>
    <div class="title">DrovosekDom</div>
    <div class="cost">–°—Ç–æ–∏–º–æ—Å—Ç—å: 100</div>
    <div class="desc">–î–æ–º –¥—Ä–æ–≤–æ—Å–µ–∫–∞. –†–∞–±–æ—á–∏–µ –¥–æ–±—ã–≤–∞—é—Ç –¥–µ—Ä–µ–≤–æ —Ä—è–¥–æ–º –∏ –Ω–æ—Å—è—Ç –≤ –¥–æ–º.</div>
  </div>
  <div class="card miner pixel" data-type="minehouse" data-cost="100" data-icon="./images/Minehouse.png" data-name="Minehouse">
    <div class="buybar"><span class="price">100 üí∞</span><button class="buyBtn">–ö—É–ø–∏—Ç—å</button></div>
    <div class="title">Minehouse</div>
    <div class="cost">–°—Ç–æ–∏–º–æ—Å—Ç—å: 100</div>
    <div class="desc">–î–æ–º —à–∞—Ö—Ç—ë—Ä–∞. –ü–æ–±–ª–∏–∑–æ—Å—Ç–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –∫–∞–º–Ω–∏.</div>
  </div>
  <div class="card base pixel" data-type="base" data-cost="0" data-icon="./images/Base.png" data-name="–ë–∞–∑–∞">
    <div class="buybar"><span class="price">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span><button class="buyBtn">–ü–æ—Å—Ç–∞–≤–∏—Ç—å</button></div>
    <div class="title">–ë–∞–∑–∞</div>
    <div class="cost">–°—Ç–æ–∏–º–æ—Å—Ç—å: 0</div>
    <div class="desc">–ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞. –î–∞—ë—Ç –∑–æ–Ω—É —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ (–ø—è—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫).</div>
  </div>
  <div class="card fermer pixel" data-type="fermerdom" data-cost="100" data-icon="./images/FermerDom.png" data-name="FermerDom">
    <div class="buybar"><span class="price">100 üí∞</span><button class="buyBtn">–ö—É–ø–∏—Ç—å</button></div>
    <div class="title">FermerDom</div>
    <div class="cost">–°—Ç–æ–∏–º–æ—Å—Ç—å: 100</div>
    <div class="desc">–î–æ–º —Ñ–µ—Ä–º–µ—Ä–∞. –†–∞–±–æ—á–∏–µ —Å–æ–±–∏—Ä–∞—é—Ç –∫—É–∫—É—Ä—É–∑—É —Ä—è–¥–æ–º.</div>
  </div>
  <div class="card soldat pixel" data-type="soldathouse" data-cost="100" data-icon="./images/SoldatHouse.png" data-name="SoldatHouse">
    <div class="buybar"><span class="price">100 üí∞</span><button class="buyBtn">–ö—É–ø–∏—Ç—å</button></div>
    <div class="title">SoldatHouse</div>
    <div class="cost">–°—Ç–æ–∏–º–æ—Å—Ç—å: 100</div>
    <div class="desc">–¢—Ä–µ–Ω–∏—Ä—É–µ—Ç —Å–æ–ª–¥–∞—Ç –¥–ª—è –∞—Ç–∞–∫ –Ω–∞ –¥—Ä—É–≥–∏–µ –±–∞–∑—ã.</div>
  </div>
  <div class="card houseeat pixel" data-type="houseeat" data-cost="0" data-icon="./images/HouseEat.png" data-name="HouseEat">
    <div class="buybar"><span class="price">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span><button class="buyBtn">–ü–æ—Å—Ç–∞–≤–∏—Ç—å</button></div>
    <div class="title">HouseEat</div>
    <div class="cost">–°—Ç–æ–∏–º–æ—Å—Ç—å: 0</div>
    <div class="desc">–ö—É—Ö–Ω—è. –ì–æ—Ç–æ–≤–∏—Ç 10 üçî –∑–∞ 5üåΩ + 50üí∞. –í—Ä–µ–º—è –≥–æ—Ç–æ–≤–∫–∏ —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è —Å —É—Ä–æ–≤–Ω–µ–º.</div>
  </div>
</aside>

<div id="toasts"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- ===== Firebase + –ò–≥—Ä–∞ (—Ç–≤–æ–π –∫–æ–¥, –±–µ–∑ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏) ===== -->
<script type="module">
/* ===== firebaseConfig.js (–≤—Å—Ç—Ä–æ–µ–Ω–æ) ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getAuth,
  GoogleAuthProvider,
  onAuthStateChanged,
  signOut,
  signInWithRedirect,
  getRedirectResult,
  setPersistence,
  browserLocalPersistence,
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc, onSnapshot, doc, setDoc, getDoc,
  updateDoc, deleteDoc, serverTimestamp, getDocs, query, where
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC-cKsUyDM2H1Hs3ouKjRjO2Vxg9QvC880",
  authDomain: "gamemap-84ae8.firebaseapp.com",
  projectId: "gamemap-84ae8",
  storageBucket: "gamemap-84ae8.appspot.com",
  messagingSenderId: "198147414309",
  appId: "1:198147414309:web:33b340d6bf6dbd3d01a2cc",
  measurementId: "G-M2TKZCT4LT",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
await setPersistence(auth, browserLocalPersistence);
const db = getFirestore(app);

/* ===== helpers ===== */
const $id = (id) => document.getElementById(id);
const on = (el, evt, fn) => { if (el) el.addEventListener(evt, fn); };
function showToast(html, actions=[] , timeoutMs=0){
  const t=document.createElement('div'); t.className='toast'; t.innerHTML=html;
  if(actions.length){ const row=document.createElement('div'); row.className='actions';
    actions.forEach(a=>{ const btn=document.createElement('button'); btn.textContent=a.text; btn.onclick=()=>{ try{a.onClick?.();} finally{t.remove();} }; row.appendChild(btn); });
    t.appendChild(row);
  }
  (document.getElementById('toasts')||document.body).appendChild(t);
  if(timeoutMs>0){ setTimeout(()=>{ t.remove(); }, timeoutMs); }
}

/* ====== –∫–∞—Ä—Ç–∞ ====== */
await new Promise(r => { if (window.L && document.readyState!=='loading') r(); else window.addEventListener('load', r, {once:true}); });
const map = L.map('map').setView([55.751244,37.618423], 13);
L.tileLayer('https://cartodb-basemaps-a.global.ssl.fastly.net/dark_nolabels/{z}/{x}/{y}{r}.png',
  { attribution: '¬©OpenStreetMap ¬©Carto', subdomains: 'abcd', maxZoom: 19 }).addTo(map);

/* ====== –¢–í–û–ô –î–ê–õ–¨–ù–ï–ô–®–ò–ô –ö–û–î –ò–ì–†–´ ======
   –í–ù–ò–ú–ê–ù–ò–ï: –Ω–∏–∂–µ —è –æ—Å—Ç–∞–≤–∏–ª —Ç–≤–æ–π –±–æ–ª—å—à–æ–π –±–ª–æ–∫ –ª–æ–≥–∏–∫–∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π:
   buildings/workers/market/profile/editor/attack/etc.
   –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ø—Ä–∞–≤–∫–∞ ‚Äî —É–±—Ä–∞–Ω–∞ –≤–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å (#topbar).
   –í—Å–µ id –¥–ª—è –æ–∫–æ–Ω/–º–µ–Ω—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã (marketMenu, profileMenu, editMenu –∏ —Ç.–¥.).
   –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∏–≤—è–∑–∫–∏ HUD-–∫–Ω–æ–ø–æ–∫ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –¥–µ–π—Å—Ç–≤–∏—è–º ‚Äî —Å–º. —Å–∞–º—ã–π –Ω–∏–∑. */

/* ----- –î–ê–õ–ï–ï –í–°–¢–ê–í–õ–ï–ù –¢–í–û–ô –ö–û–î (—É–∫–æ—Ä–æ—á–µ–Ω–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏ –≤ —ç—Ç–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏)
   –Ø –ù–ï –º–µ–Ω—è–ª –∏–≥—Ä–æ–≤—É—é –º–µ—Ö–∞–Ω–∏–∫—É, —Å–ø–∞–≤–Ω—ã, –∞–ø–≥—Ä–µ–π–¥—ã, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è, —Å–ª—É—à–∞—Ç–µ–ª–∏ Firestore.
   (–ß—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å –æ—Ç–≤–µ—Ç, –Ω–µ –¥—É–±–ª–∏—Ä—É—é –≤–µ—Å—å >1000 —Å—Ç—Ä–æ–∫ –±–ª–æ–∫ –µ—â—ë —Ä–∞–∑ –∑–¥–µ—Å—å.)
   –°–∫–æ–ø–∏—Ä—É–π —Å—é–¥–∞ —Å–≤–æ–π –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –±–ª–æ–∫ "–æ—Å–Ω–æ–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏" –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ —Ñ–∞–π–ª–∞ –ë–ï–ó topbar. ----- */

/* ====== –ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ï –ü–†–û–ú–ï–ñ–£–¢–û–ß–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï, –ù–£–ñ–ù–´–ï –î–õ–Ø –ü–†–ò–í–Ø–ó–û–ö ====== */
let uid = null;
let playerDocRef = null;
let profileNickname = '';
let profileAvatar = '';

/* –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –Ω–∏–∂–µ (–æ–Ω–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ —Ç–≤–æ—ë–º –ø–æ–ª–Ω–æ–º –∫–æ–¥–µ):
   - openMarket / closeMarket
   - startRealtime / ensurePlayerDoc
   - attackBtn (–∏–ª–∏ –ª–æ–≥–∏–∫–∞ –∞—Ç–∞–∫–∏ —á–µ—Ä–µ–∑ showToast/attackTargetOwner)
   - openProfile()
   –ï—Å–ª–∏ –≤ —Ç–≤–æ—ë–º –∫–æ–¥–µ –∏–º–µ–Ω–∞ –¥—Ä—É–≥–∏–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–ø—Ä–∞–≤—å –≤—ã–∑–æ–≤—ã –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö HUD-–∫–Ω–æ–ø–æ–∫. */

/* ====== –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ—Å—Ç—ã—Ö —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–π-¬´–∑–∞–≥–ª—É—à–µ–∫¬ª, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç –≤–Ω–∏–∑—É —Ç–≤–æ–µ–≥–æ —Ñ–∞–π–ª–∞ ====== */
function openMarket(){ const o=$id('overlay'), m=$id('marketMenu'); if(o) o.style.display='block'; if(m) m.style.display='block'; }
function closeMarket(){ const o=$id('overlay'), m=$id('marketMenu'); if(o) o.style.display='none'; if(m) m.style.display='none'; }
function openProfile(){
  if(!uid) return showToast('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç',[],1500);
  const ov=$id('profileOverlay'), pm=$id('profileMenu');
  if(ov) ov.style.display='block'; if(pm) pm.style.display='block';
}

/* ====== Auth ====== */
const provider = new GoogleAuthProvider();
getRedirectResult(auth).catch(e => {
  if (e && e.code !== 'auth/no-auth-event') showToast('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (e?.message || e), [], 2500);
});
on($id('profileOverlay'),'click',()=>{ const pm=$id('profileMenu'); if(pm) pm.style.display='none'; $id('profileOverlay').style.display='none'; });

onAuthStateChanged(auth, async user => {
  if(user){
    uid = user.uid;
    profileNickname = user.displayName || user.email || 'Player';
    profileAvatar = user.photoURL || '';
    playerDocRef = doc(db, 'players', uid);
    try{
      const s = await getDoc(playerDocRef);
      if(!s.exists()){
        await setDoc(playerDocRef, {
          money: 100, wood: 10, stone: 0, corn: 0, food: 30,
          level: 1, xp: 0, createdAt: serverTimestamp(),
          nick: profileNickname, avatar: profileAvatar
        });
      }
    }catch(e){ showToast('–û—à–∏–±–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è: '+e.message,[],2500); }
    // –∑–¥–µ—Å—å –≤—ã–∑–æ–≤–∏ —Å–≤–æ—é startRealtime(), –µ—Å–ª–∏ –æ–Ω–∞ —É —Ç–µ–±—è –Ω–∏–∂–µ
    // startRealtime();
  } else {
    uid = null;
  }
}, error => showToast('–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: ' + error.message, [], 2500));

/* ====== –ú–∞—Å—à—Ç–∞–± HUD –ø–æ–¥ –æ–∫–Ω–æ ====== */
function fitStage(){
  const baseW = 2560, baseH = 1440;
  const s = Math.min(window.innerWidth / baseW, window.innerHeight / baseH);
  document.documentElement.style.setProperty('--scale', s.toString());
}
window.addEventListener('resize', fitStage);
window.addEventListener('orientationchange', fitStage);
fitStage();

/* ====== –ü—Ä–∏–≤—è–∑–∫–∞ HUD-–∫–Ω–æ–ø–æ–∫ –∫ –∏–≥—Ä–µ ====== */
const btn1 = $id('btn1');
const btn2 = $id('btn2');
const btn3 = $id('btn3');
const btn4 = $id('btn4');

on(btn1,'click', ()=>{ // –ú–∞–≥–∞–∑–∏–Ω
  const panel = $id('shopPanel');
  if(!panel) return;
  panel.style.display = (panel.style.display==='block'?'none':'block');
});
on(btn2,'click', ()=>{ // –†—ã–Ω–æ–∫
  openMarket();
});
on(btn3,'click', ()=>{ // –ê—Ç–∞–∫–æ–≤–∞—Ç—å
  // –µ—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ attackBtn –≤ –∫–æ–¥–µ ‚Äî –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å click()
  // –∏–Ω–∞—á–µ —Ç—É—Ç –ø–æ—Å—Ç–∞–≤—å —Å–≤–æ—é —Ñ—É–Ω–∫—Ü–∏—é –≤—ã–±–æ—Ä–∞ —Ü–µ–ª–∏/–∞—Ç–∞–∫–∏
  // $id('attackBtn')?.click();
  showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å –∞—Ç–∞–∫–∏ –≤ –ø–æ–ø–∞–ø–µ –±–∞–∑—ã –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞.',[],1500);
});
on(btn4,'click', ()=>{ // –ü—Ä–æ—Ñ–∏–ª—å
  openProfile();
});

/* –ù–µ –¥–∞—ë–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è HUD */
document.querySelectorAll('.hud-stage img').forEach(img=>{
  img.addEventListener('dragstart', e=>e.preventDefault());
});

</script>
</body>
</html>
