<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Map Game ‚Äî Firebase multiplayer</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
<style>
  :root{ --cream:#F5E6C8; --accent:#ffd56a; --bar:#66e089; }
  html, body {height:100%; margin:0; background:#1e1e1e; color:#eee; font-family:'Segoe UI',sans-serif;}
  #topbar {position:fixed; top:0; left:0; right:0; background:#2b2b2b; z-index:2000; padding:10px; display:flex; flex-wrap:wrap; align-items:center; gap:12px; box-shadow:0 4px 14px rgba(0,0,0,.4);}
  #map {height:100%; margin-top:92px;}
  button {cursor:pointer; background:#444; color:#eee; border:none; padding:6px 10px; border-radius:8px; font-size:14px;}
  button:hover {background:#666;}
  .pixel {font-family:'Press Start 2P', 'VT323', monospace;}
  .leaflet-marker-icon, .leaflet-div-icon img {image-rendering: pixelated !important;}
  /* auth */
  #authBox{margin-left:auto; display:flex; align-items:center; gap:8px}
  #userName{color:#bbb; font-size:14px}
  /* —Ä–µ—Å—É—Ä—Å—ã */
  #resources {display:flex; flex-wrap:wrap; align-items:center; gap:10px; padding:6px 8px; background:#232323; border:1px solid #3a3a3a; border-radius:10px;}
  .res {display:flex; align-items:center; gap:6px; padding:4px 8px; background:#1a1a1a; border:1px solid #3a3a3a; border-radius:8px;}
  .res b {font-variant-numeric: tabular-nums;}
  /* XP */
  #xpWrap{display:flex; align-items:center; gap:10px; min-width:260px}
  #xpText{font-variant-numeric: tabular-nums;}
  #xpBar{width:220px; height:10px; background:#111; border:1px solid #555; border-radius:999px; overflow:hidden}
  #xpBar .fill{height:100%; width:0%; background:var(--bar);}
  /* —Ç–æ—Å—Ç—ã */
  #toasts {position:fixed; right:12px; bottom:12px; display:flex; flex-direction:column; gap:8px; z-index:2500;}
  .toast {background:#2d2b2d; border:1px solid #444; border-radius:10px; padding:10px 12px; box-shadow:0 8px 24px rgba(0,0,0,.35); min-width:280px;}
  .toast .actions {margin-top:8px; display:flex; gap:8px; justify-content:flex-end;}
  /* –≤—ã–¥–µ–ª–µ–Ω–∏–µ / –ø—Ä–æ–≥—Ä–µ—Å—Å */
  .marker-selected {filter: drop-shadow(0 0 6px rgba(0,255,255,.8));}
  .progress-wrap {background:rgba(0,0,0,.6); border:1px solid #777; width:64px; height:8px; border-radius:10px; overflow:hidden; transform: translate(-50%,-130%);}
  .progress-bar {height:100%; width:0%; background:var(--bar);}
  .worker {width:48px; height:48px; transform: translate(-50%, -50%);}
  .worker img {width:48px; height:48px;}
  .flip-x {transform: scaleX(-1);}
  /* —Ä–µ–¥–∞–∫—Ç–æ—Ä */
  #editMenu {position:fixed; top:96px; right:10px; background:#2b2b2b; padding:12px; border-radius:12px; display:none; flex-direction:column; gap:8px; z-index:2200; width:340px; box-shadow:0 8px 24px rgba(0,0,0,.35);}
  #paintCanvas {image-rendering:pixelated; border:1px solid #555; background:#000; width:480px; height:480px; align-self:center;}
  .colorPalette {display:flex; flex-wrap:wrap; gap:4px; margin-top:4px;}
  .colorTile {width:18px; height:18px; cursor:pointer; border:1px solid #555;}
  #canvasInfo {color:#aaa; font-size:12px;}
  /* –æ–≤–µ—Ä–ª–µ–π/—Ä—ã–Ω–æ–∫ */
  #overlay {position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; z-index:2100;}
  #marketMenu{
    position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
    background:#2b2b2b; border:1px solid #444; border-radius:12px; padding:16px; width:560px; max-width:95vw; z-index:2200;
    box-shadow:0 12px 28px rgba(0,0,0,.4); display:none;
  }
  .row {display:flex; align-items:center; justify-content:space-between; gap:10px; margin:8px 0;}
  .tag {background:#1a1a1a; border:1px solid #3a3a3a; border-radius:8px; padding:6px 10px;}
  .seg {display:flex; gap:6px; align-items:center;}
  .tabs {display:flex; gap:8px; margin-bottom:8px;}
  .tabs button {background:#333}
  .tabs .active {background:#555}
  /* –º–∞–≥–∞–∑–∏–Ω */
  #shopPanel{position:fixed; top:88px; left:0; bottom:0; width:330px; background:#222; border-right:1px solid #3a3a3a; z-index:2150; display:none; overflow-y:auto; padding:12px; box-shadow:8px 0 20px rgba(0,0,0,.35);}
  #shopHeader{display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;}
  .card{position:relative; width:300px; height:438px; margin:10px auto; image-rendering:pixelated; border-radius:12px; box-shadow:0 10px 18px rgba(0,0,0,.35); cursor:pointer; overflow:hidden;}
  .card.drov {background:url('./images/CardDrovosek.png') center/cover no-repeat;}
  .card.miner {background:url('./images/CardMiner.png') center/cover no-repeat;}
  .card.base {background:url('./images/CardBase.png') center/cover no-repeat;}
  .card.fermer {background:url('./images/Cardeda.png') center/cover no-repeat;}
  .card.eat {background:url('./images/CardHouseEat.png') center/cover no-repeat;}
  .card .title{position:absolute; top:18px; left:84px; right:16px; font-size:13px; color:var(--cream); text-shadow:0 1px 0 #000;}
  .card .cost {position:absolute; top:46px; left:84px; right:16px; font-size:12px; color:var(--cream); text-shadow:0 1px 0 #000;}
  .card .desc {position:absolute; left:30px; right:30px; bottom:22px; font-size:12px; line-height:1.25; color:var(--cream); text-shadow:0 1px 0 #000;}
  .card .buybar{position:absolute; top:0; left:0; right:0; height:60px; z-index:3; background:linear-gradient(#2b2b2b,#1e1e1e); border-bottom:1px solid #555; display:flex; align-items:center; justify-content:center; gap:10px; transform:translateY(-100%); transition:transform .25s ease;}
  .card.active .buybar{transform:translateY(0);}
  .buybar .price{font-size:12px; color:var(--accent)}
  .card:hover{filter:brightness(1.07);}
  .is-hidden {opacity:0; pointer-events:none;}
</style>
</head>
<body>
<div id="topbar">
  <div><b>Map Game ‚Äî Firebase</b></div>
  <div id="resources"></div>
  <div id="xpWrap">
    <span id="xpText">Lv 1 ‚Ä¢ 0/500</span>
    <div id="xpBar"><div class="fill"></div></div>
  </div>
  <button id="shopToggle">–ú–∞–≥–∞–∑–∏–Ω</button>
  <button id="marketBtn">–†—ã–Ω–æ–∫</button>
  <div id="authBox">
    <span id="userName"></span>
    <button id="loginBtn">–í–æ–π—Ç–∏ —Å Google</button>
    <button id="logoutBtn" style="display:none">–í—ã–π—Ç–∏</button>
  </div>
</div>
<!-- —Ä–µ–¥–∞–∫—Ç–æ—Ä -->
<div id="editMenu">
  <h4>–†–µ–¥–∞–∫—Ç–æ—Ä —Å–ø—Ä–∞–π—Ç–∞</h4>
  <canvas id="paintCanvas" width="60" height="60"></canvas>
  <div id="canvasInfo">–õ–æ–≥–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ: 60√ó60</div>
  <div class="colorPalette" id="palette"></div>
  <div style="display:flex; gap:8px; justify-content:flex-end;">
    <button id="saveSprite">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button id="closeEditor">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>
<!-- —Ä—ã–Ω–æ–∫ -->
<div id="overlay" style="display:none"></div>
<div id="marketMenu" style="display:none">
  <h3>–†—ã–Ω–æ–∫</h3>
  <div class="tabs">
    <button id="tabWood" class="active">ü™µ –î–µ—Ä–µ–≤–æ</button>
    <button id="tabStone">ü™® –ö–∞–º–µ–Ω—å</button>
    <button id="tabCorn">üåΩ –ö—É–∫—É—Ä—É–∑–∞</button>
  </div>
  <div class="row">
    <div>–ö—É—Ä—Å: <span id="m-rate" class="tag">10 ü™µ = 50 üí∞</span></div>
    <div>–£ –≤–∞—Å: <span id="m-have" class="num">0</span></div>
  </div>
  <div class="row">
    <div>–ü—Ä–æ–¥–∞—Ç—å –Ω–∞–±–æ—Ä–æ–≤ (–ø–æ 10):</div>
    <div class="seg">
      <button id="m-dec">‚àí1</button>
      <span id="m-packs" class="tag num" style="min-width:48px;text-align:center">0</span>
      <button id="m-inc">+1</button>
      <button id="m-max">MAX</button>
    </div>
  </div>
  <div class="row">
    <div>–ü–æ–ª—É—á–∏—Ç–µ:</div>
    <div><b id="m-get" class="num">0</b> üí∞</div>
  </div>
  <div class="actions">
    <button id="m-cancel">–û—Ç–º–µ–Ω–∞</button>
    <button id="m-sell">–ü—Ä–æ–¥–∞—Ç—å</button>
    <button id="m-sell-all">–ü—Ä–æ–¥–∞—Ç—å –≤—Å—ë</button>
  </div>
</div>
<!-- –º–∞–≥–∞–∑–∏–Ω -->
<aside id="shopPanel">
  <div id="shopHeader">
    <h3 class="pixel">–ú–∞–≥–∞–∑–∏–Ω</h3>
    <button id="shopClose">√ó</button>
  </div>
  <div class="card drov pixel" data-type="drovosekdom" data-cost="100" data-icon="./images/DrovosekDom.png" data-name="DrovosekDom">
    <div class="buybar"><span class="price">100 üí∞</span><button class="buyBtn">–ö—É–ø–∏—Ç—å</button></div>
    <div class="title">DrovosekDom</div>
    <div class="cost">–°—Ç–æ–∏–º–æ—Å—Ç—å: 100</div>
    <div class="desc">–î–æ–º –¥—Ä–æ–≤–æ—Å–µ–∫–∞. –†–∞–±–æ—á–∏–µ –¥–æ–±—ã–≤–∞—é—Ç –¥–µ—Ä–µ–≤–æ —Ä—è–¥–æ–º –∏ –Ω–æ—Å—è—Ç –≤ –¥–æ–º.</div>
  </div>
  <div class="card miner pixel" data-type="minehouse" data-cost="100" data-icon="./images/Minehouse.png" data-name="Minehouse">
    <div class="buybar"><span class="price">100 üí∞</span><button class="buyBtn">–ö—É–ø–∏—Ç—å</button></div>
    <div class="title">Minehouse</div>
    <div class="cost">–°—Ç–æ–∏–º–æ—Å—Ç—å: 100</div>
    <div class="desc">–î–æ–º —à–∞—Ö—Ç—ë—Ä–∞. –ü–æ–±–ª–∏–∑–æ—Å—Ç–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –∫–∞–º–Ω–∏.</div>
  </div>
  <div class="card base pixel" data-type="base" data-cost="0" data-icon="./images/Base.png" data-name="–ë–∞–∑–∞">
    <div class="buybar"><span class="price">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span><button class="buyBtn">–ü–æ—Å—Ç–∞–≤–∏—Ç—å</button></div>
    <div class="title">–ë–∞–∑–∞</div>
    <div class="cost">–°—Ç–æ–∏–º–æ—Å—Ç—å: 0</div>
    <div class="desc">–ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞. –î–∞—ë—Ç –∑–æ–Ω—É —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ (–ø—è—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫).</div>
  </div>
  <div class="card fermer pixel" data-type="fermerdom" data-cost="100" data-icon="./images/FermerDom.png" data-name="FermerDom">
    <div class="buybar"><span class="price">100 üí∞</span><button class="buyBtn">–ö—É–ø–∏—Ç—å</button></div>
    <div class="title">FermerDom</div>
    <div class="cost">–°—Ç–æ–∏–º–æ—Å—Ç—å: 100</div>
    <div class="desc">–î–æ–º —Ñ–µ—Ä–º–µ—Ä–∞. –†–∞–±–æ—á–∏–µ —Å–æ–±–∏—Ä–∞—é—Ç –∫—É–∫—É—Ä—É–∑—É —Ä—è–¥–æ–º.</div>
  </div>
  <div class="card eat pixel" data-type="houseeat" data-cost="0" data-icon="./images/HouseEat.png" data-name="HouseEat">
    <div class="buybar"><span class="price">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span><button class="buyBtn">–ü–æ—Å—Ç–∞–≤–∏—Ç—å</button></div>
    <div class="title">HouseEat</div>
    <div class="cost">–°—Ç–æ–∏–º–æ—Å—Ç—å: 0</div>
    <div class="desc">–ó–∞–≤–æ–¥ –ø–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤—É –µ–¥—ã. –ì–æ—Ç–æ–≤–∏—Ç –µ–¥—É –¥–ª—è —Ä–∞–±–æ—á–∏—Ö.</div>
  </div>
</aside>
<div id="map"></div>
<div id="toasts"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
<!-- === FIREBASE + GAME LOGIC === -->
<script type="module">
/* ---------- Firebase (CDN, –º–æ–¥—É–ª—å–Ω—ã–π SDK) ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc, getDoc, updateDoc, deleteDoc, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
/* —Ç–≤–æ–π –∫–æ–Ω—Ñ–∏–≥ */
const firebaseConfig = {
  apiKey: "AIzaSyC-cKsUyDM2H1Hs3ouKjRjO2Vxg9QvC880",
  authDomain: "gamemap-84ae8.firebaseapp.com",
  projectId: "gamemap-84ae8",
  storageBucket: "gamemap-84ae8.firebasestorage.app",
  messagingSenderId: "198147414309",
  appId: "1:198147414309:web:33b340d6bf6dbd3d01a2cc",
  measurementId: "G-M2TKZCT4LT"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
/* ---------- UI auth ---------- */
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const userName = document.getElementById('userName');
loginBtn.onclick = async () => {
  try { await signInWithPopup(auth, new GoogleAuthProvider()); }
  catch (e) { showToast('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (e?.message||e), [], 2500); }
};
logoutBtn.onclick = async () => { try{ await signOut(auth); }catch(e){} };
let uid = null; // —Ç–µ–∫—É—â–∏–π –∏–≥—Ä–æ–∫
let playerDocRef = null; // —Å—Å—ã–ª–∫–∞ –Ω–∞ players/{uid}
/* ---------- –ò–≥—Ä–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–ª–æ–∫–∞–ª—å–Ω–æ) ---------- */
const BASE_XP = 500;
let level = 1, xp = 0;
const resources = { money: 100, wood: 10, stone: 0, corn: 0, food: 30 };
/* ---------- helpers UI ---------- */
function updateResourcePanel(){
  document.getElementById('resources').innerHTML = `
    <div class="res">üí∞ <b id="r-money">${resources.money}</b></div>
    <div class="res">ü™µ <b id="r-wood">${resources.wood}</b></div>
    <div class="res">ü™® <b id="r-stone">${resources.stone}</b></div>
    <div class="res">üåΩ <b id="r-corn">${resources.corn}</b></div>
    <div class="res">üçî <b id="r-food">${resources.food}</b></div>`;
}
updateResourcePanel();
function getRequiredXp(currentLevel) {
  return BASE_XP * currentLevel;
}
function addXP(amount){
  xp += amount;
  let required = getRequiredXp(level);
  while (xp >= required) {
    xp -= required;
    level++;
    required = getRequiredXp(level);
    showToast(`üìà –£—Ä–æ–≤–µ–Ω—å ${level}!`,[],1500);
  }
  document.querySelector('#xpText').textContent = `Lv ${level} ‚Ä¢ ${xp}/${required}`;
  const p = Math.max(0, Math.min(1, xp / required)) * 100;
  document.querySelector('#xpBar .fill').style.width = p + '%';
  if (uid && playerDocRef) updateDoc(playerDocRef, { level, xp });
}
addXP(0);
/* ---------- –∫–∞—Ä—Ç–∞ ---------- */
await new Promise(r => { if (window.L) r(); else window.addEventListener('load', r, {once:true}); });
const map = L.map('map').setView([55.751244,37.618423], 13);
L.tileLayer('https://cartodb-basemaps-a.global.ssl.fastly.net/dark_nolabels/{z}/{x}/{y}{r}.png',
  { attribution: '¬©OpenStreetMap ¬©Carto', subdomains: 'abcd', maxZoom: 19 }).addTo(map);
function metersToLat(m){ return m/111000; }
function metersToLng(m, lat){ return m/(111000*Math.cos(lat*Math.PI/180)); }
/* –≤–∏–¥–∏–º–æ—Å—Ç—å –ø–æ –∑—É–º—É */
const SPRITES_Z_MIN = 0;
function isSpriteZoomVisible(z){ return z >= SPRITES_Z_MIN; }
function setMarkerHidden(m, hidden){
  const el = m?.getElement?.();
  if(el){ el.classList.toggle('is-hidden', hidden); }
  if(hidden && m?.isPopupOpen && m.isPopupOpen()) m.closePopup();
}
map.on('zoomend', ()=>{
  const hidden = !isSpriteZoomVisible(map.getZoom());
  [...markers.values()].forEach(m=>setMarkerHidden(m, hidden));
  trees.forEach(t=>setMarkerHidden(t.marker, hidden));
  rocks.forEach(r=>setMarkerHidden(r.marker, hidden));
  corn.forEach(c=>setMarkerHidden(c.marker, hidden));
  if(ghostMarker) setMarkerHidden(ghostMarker, hidden);
});
/* ---------- –∑–¥–∞–Ω–∏—è/–æ–±—ä–µ–∫—Ç—ã ---------- */
const markers=new Map(); // id -> L.marker
const buildingData=new Map(); // id -> {type, owner, name, level}
const selectedMarkers=new Set();
const otherBaseZones = new Map(); // id -> polygon for other players' bases
let baseMarker=null, baseZone=null;
let baseMeta={ level:0, color:'#00ffcc', paintSize:32, poly:{angles:[], radii:[]} };
const BASE_LEVELS = {
  1: { radius: 150, icon: 120, cost: 0, paint: 32 },
  2: { radius: 220, icon: 148, cost: 200, paint: 64 },
  3: { radius: 300, icon: 176, cost: 500, paint: 128 },
  4: { radius: 380, icon: 208, cost: 1000, paint: 256 },
};
const DROVOSEKDOM_LEVELS = {
  1: { icon: 96, cost: 150, workers: 3, paint: 60 },
  2: { icon: 112, cost: 350, workers: 5, paint: 72 },
  3: { icon: 128, cost: 650, workers: 9, paint: 84 },
  4: { icon: 144, cost: 1050, workers: 15, paint: 96 },
};
const MINEHOUSE_LEVELS = JSON.parse(JSON.stringify(DROVOSEKDOM_LEVELS));
const FERMERVOM_LEVELS = JSON.parse(JSON.stringify(DROVOSEKDOM_LEVELS));
const HOUSEEAT_LEVELS = {
  1: { icon: 96, cost: 0, workers: 0, paint: 60, foodTime: 60, foodYield: 10 },
  2: { icon: 112, cost: 200, workers: 0, paint: 72, foodTime: 50, foodYield: 10 },
  3: { icon: 128, cost: 400, workers: 0, paint: 84, foodTime: 40, foodYield: 10 },
  4: { icon: 144, cost: 600, workers: 0, paint: 96, foodTime: 30, foodYield: 10 },
};
function randomBrightColor(){ const h = Math.floor(Math.random()*360); return `hsl(${h} 95% 60%)`; }
function makeBasePolyAround(center, radiusM){
  const start = Math.random()*Math.PI*2;
  const angles=[], radii=[];
  for(let i=0;i<5;i++){
    const ang = start + i*(2*Math.PI/5);
    const r = radiusM * (0.9 + Math.random()*0.2);
    angles.push(ang); radii.push(r);
  }
  return {angles, radii};
}
function polyToLatLngs(center, poly){
  const pts=[];
  for(let i=0;i<poly.angles.length;i++){
    const ang=poly.angles[i], r=poly.radii[i];
    const dy = metersToLat( Math.sin(ang)*r );
    const dx = metersToLng( Math.cos(ang)*r, center.lat );
    pts.push([ center.lat + dy, center.lng + dx ]);
  }
  return pts;
}
function pointInPolygon(latlng, polyLatLngs){
  let inside=false;
  for(let i=0,j=polyLatLngs.length-1; i<polyLatLngs.length; j=i++){
    const xi=polyLatLngs[i][1], yi=polyLatLngs[i][0];
    const xj=polyLatLngs[j][1], yj=polyLatLngs[j][0];
    const x=latlng.lng, y=latlng.lat;
    const intersect = ((yi>y)!=(yj>y)) && (x < (xj-xi)*(y-yi)/(yj-yi+1e-12)+xi);
    if(intersect) inside=!inside;
  }
  return inside;
}
function applyBaseZone(){
  if(!baseMarker || !baseMeta.level) return;
  const center = baseMarker.getLatLng();
  const pts = polyToLatLngs(center, baseMeta.poly);
  if(baseZone) baseZone.remove();
  baseZone = L.polygon(pts, {
    color: baseMeta.color, weight: 3, opacity: 1,
    fillColor: baseMeta.color, fillOpacity: 0.15, interactive: false
  }).addTo(map);
}
function applyOtherBaseZone(id, b){
  const center = L.latLng(b.lat, b.lng);
  const pts = polyToLatLngs(center, b.poly || makeBasePolyAround(center, BASE_LEVELS[b.level].radius));
  const color = b.color || '#888888'; // gray for other players
  const zone = L.polygon(pts, {
    color: color, weight: 3, opacity: 1,
    fillColor: color, fillOpacity: 0.15, interactive: false
  }).addTo(map);
  otherBaseZones.set(id, zone);
}
function iconSpecForType(type, level=1){
  if(type==='base'){
    const lvl = BASE_LEVELS[baseMeta.level||1] || BASE_LEVELS[1];
    return {size:[lvl.icon,lvl.icon], anchor:[lvl.icon/2,lvl.icon/2]};
  } else if (type === 'houseeat') {
    const lvl = HOUSEEAT_LEVELS[level] || HOUSEEAT_LEVELS[1];
    return {size:[lvl.icon,lvl.icon], anchor:[lvl.icon/2,lvl.icon/2]};
  }
  const table = type==='drovosekdom'?DROVOSEKDOM_LEVELS: type==='minehouse'?MINEHOUSE_LEVELS: FERMERVOM_LEVELS;
  const lvl = table[level] || table[1];
  return {size:[lvl.icon,lvl.icon], anchor:[lvl.icon/2,lvl.icon/2]};
}
function iconUrlForType(type){
  if(type==='base') return './images/Base.png';
  if(type==='drovosekdom') return './images/DrovosekDom.png';
  if(type==='minehouse') return './images/Minehouse.png';
  if(type==='fermerdom') return './images/FermerDom.png';
  if(type==='houseeat') return './images/HouseEat.png';
  return './images/House.png';
}
function nextBaseCost(){ return (baseMeta.level>=4)?null:BASE_LEVELS[baseMeta.level+1].cost; }
function nextCostFor(b){
  if(b.type==='drovosekdom') return (b.level>=4)?null:DROVOSEKDOM_LEVELS[b.level+1].cost;
  if(b.type==='minehouse') return (b.level>=4)?null:MINEHOUSE_LEVELS[b.level+1].cost;
  if(b.type==='fermerdom') return (b.level>=4)?null:FERMERVOM_LEVELS[b.level+1].cost;
  if(b.type==='houseeat') return (b.level>=4)?null:HOUSEEAT_LEVELS[b.level+1].cost;
  return null;
}
/* –Ω–∞–±–æ—Ä—ã —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤ —É —Å–≤–æ–∏—Ö –¥–æ–º–æ–≤ */
const woodcuttersByHome = new Map();
const minersByHome = new Map();
const farmersByHome = new Map();
function getTotalWorkers(type) {
  let total = 0;
  const homes = (type === 'drovosekdom') ? woodcuttersByHome : (type === 'minehouse') ? minersByHome : farmersByHome;
  homes.forEach(set => total += set.size);
  return total;
}
function getTotalHouseLevel(type) {
  let total = 0;
  buildingData.forEach(b => {
    if (b.type === type && b.owner === uid) total += b.level;
  });
  return total;
}
function makePopupHtml(b){
  const owner = b.owner ? (b.owner===uid?'(–≤—ã)':b.owner.slice(0,6)) : '';
  const name = b.name || b.type;
  const canEdit = (b.owner===uid);
  let workersText = '';
  if(b.type==='drovosekdom'){
    const set = woodcuttersByHome.get(b.id) || new Set();
    const max = DROVOSEKDOM_LEVELS[b.level].workers;
    workersText = `<br/>–†–∞–±–æ—á–∏–µ: ${set.size}/${max}`;
  } else if(b.type==='minehouse'){
    const set = minersByHome.get(b.id) || new Set();
    const max = MINEHOUSE_LEVELS[b.level].workers;
    workersText = `<br/>–†–∞–±–æ—á–∏–µ: ${set.size}/${max}`;
  } else if(b.type==='fermerdom'){
    const set = farmersByHome.get(b.id) || new Set();
    const max = FERMERVOM_LEVELS[b.level].workers;
    workersText = `<br/>–†–∞–±–æ—á–∏–µ: ${set.size}/${max}`;
  }
  const editBtn = canEdit ? `<button onclick="editBuilding('${b.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>` : '';
  const delBtn = canEdit ? `<button onclick="window.deleteBuilding('${b.id}')">–£–¥–∞–ª–∏—Ç—å</button>` : '';
  const hireWood = (canEdit && b.type==='drovosekdom') ? `<button onclick="hireWoodcutter('${b.id}')">–ù–∞–Ω—è—Ç—å –¥—Ä–æ–≤–æ—Å–µ–∫–∞</button>` : '';
  const hireMiner = (canEdit && b.type==='minehouse') ? `<button onclick="hireMiner('${b.id}')">–ù–∞–Ω—è—Ç—å —à–∞—Ö—Ç—ë—Ä–∞</button>` : '';
  const hireFermer = (canEdit && b.type==='fermerdom') ? `<button onclick="hireFermer('${b.id}')">–ù–∞–Ω—è—Ç—å —Ñ–µ—Ä–º–µ—Ä–∞</button>` : '';
  const upBtn = (canEdit && b.type!=='base' && b.type !== 'houseeat')
    ? `<button onclick="window.upgradeBuilding('${b.id}')">–£–ª—É—á—à–∏—Ç—å (${nextCostFor(b)}üí∞)</button>` : '';
  const baseUp = (canEdit && b.type==='base' && nextBaseCost()!=null)
    ? `<button onclick="window.upgradeBase()">–£–ª—É—á—à–∏—Ç—å –±–∞–∑—É (${nextBaseCost()}üí∞)</button>` : '';
  const cookFood = (canEdit && b.type === 'houseeat' && resources.corn >= 5 && resources.money >= 50)
    ? `<button onclick="cookFood('${b.id}')">–ü—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å –µ–¥—É (5üåΩ, 50üí∞)</button>` : '';
  return `üè† <b>${name}</b><br/>–¢–∏–ø: ${b.type}<br/>–£—Ä–æ–≤–µ–Ω—å: ${b.level} ${owner?('<br/>–í–ª–∞–¥–µ–ª–µ—Ü: '+owner):''}${workersText}<br/>${editBtn} ${delBtn} ${hireWood} ${hireMiner} ${hireFermer} ${upBtn} ${baseUp} ${cookFood}`;
}
/* –¥–æ–±–∞–≤–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å –º–∞—Ä–∫–µ—Ä –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç—É */
function renderBuildingDoc(id, data){
  console.log('Rendering building:', id, data); // Debug log
  const b = { id, ...data };
  const existed = markers.has(id);
  if(!existed){
    const spec = iconSpecForType(b.type, b.level||1);
    const iconUrl = b.customIcon || iconUrlForType(b.type);
    const marker = L.marker([b.lat, b.lng], {icon: L.icon({iconUrl, iconSize: spec.size, iconAnchor: spec.anchor})}).addTo(map);
    console.log('New marker created at:', b.lat, b.lng); // Debug log
    setMarkerHidden(marker, !isSpriteZoomVisible(map.getZoom()));
    marker.options.owner = b.owner;
    marker.options.buildingId = id;
    marker.currentIcon = iconUrl;
    marker.bindPopup(makePopupHtml(b));
    marker.on('click', () => {
      const el = marker.getElement();
      if(selectedMarkers.has(marker)){
        marker.setOpacity(1); selectedMarkers.delete(marker); el?.classList.remove('marker-selected');
      } else if(b.owner===uid){
        marker.setOpacity(0.7); selectedMarkers.add(marker); el?.classList.add('marker-selected');
      }
    });
    markers.set(id, marker);
    buildingData.set(id, b);
    if(b.type==='drovosekdom' && b.owner===uid && !woodcuttersByHome.has(id)) woodcuttersByHome.set(id, new Set());
    if(b.type==='minehouse' && b.owner===uid && !minersByHome.has(id)) minersByHome.set(id, new Set());
    if(b.type==='fermerdom' && b.owner===uid && !farmersByHome.has(id)) farmersByHome.set(id, new Set());
  } else {
    const marker = markers.get(id);
    const prev = buildingData.get(id);
    buildingData.set(id, b);
    marker.bindPopup(makePopupHtml(b));
    if(prev.level !== b.level){
      const spec = iconSpecForType(b.type, b.level);
      marker.setIcon(L.icon({iconUrl: marker.currentIcon|| (b.customIcon || iconUrlForType(b.type)), iconSize:spec.size, iconAnchor:spec.anchor}));
    }
  }
  if(b.type==='base' && b.owner===uid){
    baseMarker = markers.get(id);
    baseMeta.level = b.level;
    baseMeta.color = b.color || randomBrightColor();
    baseMeta.poly = b.poly || makeBasePolyAround(baseMarker.getLatLng(), BASE_LEVELS[b.level].radius);
    applyBaseZone();
  } else if (b?.type==='base' && b.owner !== uid && b.poly) {
    applyOtherBaseZone(id, b);
  }
}
function unrenderBuildingDoc(id){
  console.log('Unrendering building:', id); // Debug log
  const marker = markers.get(id);
  const b = buildingData.get(id);
  if(!marker) return;
  map.removeLayer(marker);
  markers.delete(id);
  buildingData.delete(id);
  if(b?.type==='base' && b.owner===uid){
    if(baseZone){ baseZone.remove(); baseZone=null; }
    baseMarker=null; baseMeta={ level:0, color:randomBrightColor(), paintSize:32, poly:{angles:[],radii:[]} };
  } else if (b?.type==='base' && b.owner !== uid) {
    const zone = otherBaseZones.get(id);
    if (zone) {
      zone.remove();
      otherBaseZones.delete(id);
    }
  }
  if (b?.type === 'drovosekdom' && b.owner === uid) {
    woodcuttersByHome.delete(id);
  } else if (b?.type === 'minehouse' && b.owner === uid) {
    minersByHome.delete(id);
  } else if (b?.type === 'fermerdom' && b.owner === uid) {
    farmersByHome.delete(id);
  }
}
/* ---------- Firestore listeners ---------- */
let buildingsUnsub = null;
let playerUnsub = null;
function startRealtime(){
  if (!uid) {
    console.error('Cannot startRealtime: uid is null');
    showToast('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω.', [], 2500);
    return;
  }
  playerDocRef = doc(db, 'players', uid);
  playerUnsub = onSnapshot(playerDocRef, snap => {
    if(snap.exists()){
      const d = snap.data();
      console.log('Player data updated:', d); // Debug log
      resources.money = d.money ?? 100;
      resources.wood = d.wood ?? 10;
      resources.stone = d.stone ?? 0;
      resources.corn = d.corn ?? 0;
      resources.food = d.food ?? 30;
      level = d.level ?? 1;
      xp = d.xp ?? 0;
      updateResourcePanel();
      addXP(0);
    } else {
      console.warn('Player document does not exist, creating...');
      ensurePlayerDoc();
    }
  }, error => {
    console.error('Player snapshot error:', error);
    showToast('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä–æ–∫–∞: ' + error.message, [], 2500);
  });
  buildingsUnsub = onSnapshot(collection(db, 'buildings'), snap => {
    console.log('Buildings snapshot received, changes:', snap.docChanges().length); // Debug log
    snap.docChanges().forEach(ch => {
      console.log('Firestore change:', ch.type, ch.doc.id, ch.doc.data()); // Debug log
      if(ch.type === 'added' || ch.type === 'modified') renderBuildingDoc(ch.doc.id, ch.doc.data());
      if(ch.type === 'removed') unrenderBuildingDoc(ch.doc.id);
    });
  }, error => {
    console.error('Buildings snapshot error:', error);
    showToast('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–¥–∞–Ω–∏–π: ' + error.message, [], 2500);
  });
  // –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ –æ—Ç –±–∞–∑—ã
  setInterval(() => {
    if (baseMeta.level > 0) {
      resources.money += baseMeta.level; // –î–æ–±–∞–≤–ª—è–µ–º –º–æ–Ω–µ—Ç—ã –ø–æ —É—Ä–æ–≤–Ω—é –±–∞–∑—ã
      updateResourcePanel();
    }
  }, 1000); // –ö–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Firestore –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
  setInterval(async () => {
    if (uid && playerDocRef) {
      try {
        await updateDoc(playerDocRef, { money: resources.money, food: resources.food });
        console.log('Money and food saved to Firestore:', resources.money, resources.food);
      } catch (e) {
        console.error('Error saving money and food:', e);
      }
    }
  }, 5000); // –ö–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
}
async function ensurePlayerDoc(){
  if (!uid || !playerDocRef) {
    console.error('Cannot ensurePlayerDoc: uid or playerDocRef is null');
    showToast('–û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω.', [], 2500);
    return;
  }
  try {
    const s = await getDoc(playerDocRef);
    if(!s.exists()){
      console.log('Creating new player document for uid:', uid); // Debug log
      await setDoc(playerDocRef, {
        money: 100, wood: 10, stone: 0, corn: 0, food: 30,
        level: 1, xp: 0, createdAt: serverTimestamp()
      });
    }
  } catch (e) {
    console.error('Error in ensurePlayerDoc:', e);
    showToast('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –∏–≥—Ä–æ–∫–∞: ' + e.message, [], 2500);
  }
}
/* ---------- auth state ---------- */
onAuthStateChanged(auth, async user => {
  console.log('Auth state changed:', user ? user.uid : 'null'); // Debug log
  if(user){
    uid = user.uid;
    userName.textContent = user.displayName || user.email || 'Player';
    loginBtn.style.display='inline-block';
    loginBtn.textContent = '–°–º–µ–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç';
    logoutBtn.style.display='inline-block';
    playerDocRef = doc(db, 'players', uid);
    await ensurePlayerDoc();
    startRealtime();
  } else {
    uid = null;
    userName.textContent = '';
    loginBtn.textContent = '–í–æ–π—Ç–∏ —Å Google';
    logoutBtn.style.display='none';
    buildingsUnsub?.();
    playerUnsub?.();
    buildingsUnsub = playerUnsub = null;
    markers.clear();
    buildingData.clear();
    if(baseZone) { baseZone.remove(); baseZone = null; }
    baseMarker = null;
    otherBaseZones.forEach(zone => zone.remove());
    otherBaseZones.clear();
  }
}, error => {
  console.error('Auth state error:', error);
  showToast('–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: ' + error.message, [], 2500);
});
/* ====== —Ä–µ—Å—É—Ä—Å—ã –Ω–∞ –∫–∞—Ä—Ç–µ (–¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ) ====== */
const TREE_ICONS = [
  new L.Icon({iconUrl:'./images/Tree1.png', iconSize:[48,48], iconAnchor:[24,36]}),
  new L.Icon({iconUrl:'./images/Tree2.png', iconSize:[48,48], iconAnchor:[24,36]}),
  new L.Icon({iconUrl:'./images/Tree3.png', iconSize:[48,48], iconAnchor:[24,36]}),
];
const trees = new Map();
const TREE_SPAWN_INTERVAL_MS = 60_000, TREE_RADIUS_MAX_M = 100, TREE_RADIUS_MIN_M = 20;
const ROCK_ICONS = [
  new L.Icon({iconUrl:'./images/Kamen.png', iconSize:[48,48], iconAnchor:[24,36]}),
  new L.Icon({iconUrl:'./images/Kamen2.png', iconSize:[48,48], iconAnchor:[24,36]}),
  new L.Icon({iconUrl:'./images/Kamen3.png', iconSize:[48,48], iconAnchor:[24,36]}),
];
const rocks = new Map();
const ROCK_SPAWN_INTERVAL_MS = 60_000, ROCK_RADIUS_MAX_M = 100, ROCK_RADIUS_MIN_M = 20;
const CORN_ICONS = [
  new L.Icon({iconUrl:'./images/Corn.png', iconSize:[48,48], iconAnchor:[24,36]}),
  new L.Icon({iconUrl:'./images/Corn2.png', iconSize:[48,48], iconAnchor:[24,36]}),
  new L.Icon({iconUrl:'./images/Corn3.png', iconSize:[48,48], iconAnchor:[24,36]}),
];
const corn = new Map();
const CORN_SPAWN_INTERVAL_MS = 60_000, CORN_RADIUS_MAX_M = 100, CORN_RADIUS_MIN_M = 20;
function randBetween(a,b){ return a + Math.random()*(b-a); }
function pickPointNear(latlng, maxM, minM){
  const r = randBetween(minM, maxM);
  const ang = Math.random()*2*Math.PI;
  return { lat: latlng.lat + metersToLat(r)*Math.sin(ang),
           lng: latlng.lng + metersToLng(r*Math.cos(ang), latlng.lat) };
}
function getDomAnchors(type){
  const anchors=[]; buildingData.forEach((b,id)=>{ if(b.type===type){ const m=markers.get(id); if(m) anchors.push(m.getLatLng()); } });
  return anchors;
}
function spawnTreesBatch(){
  const anchors = getDomAnchors('drovosekdom'); if(anchors.length===0) return;
  const totalWorkers = getTotalWorkers('drovosekdom');
  const totalLevel = getTotalHouseLevel('drovosekdom');
  const TREE_CAP = (totalWorkers * 10) + (totalLevel * 5) || 50;
  const need = Math.max(0, TREE_CAP - trees.size); if(need===0) return;
  const toSpawn = Math.min(6, need);
  for(let i=0;i<toSpawn;i++){
    const anchor = anchors[Math.floor(Math.random()*anchors.length)];
    const pt = pickPointNear(anchor, TREE_RADIUS_MAX_M, TREE_RADIUS_MIN_M);
    const id = crypto.randomUUID?.() || Math.random().toString(36).slice(2);
    const m = L.marker([pt.lat, pt.lng], {icon: TREE_ICONS[Math.floor(Math.random()*TREE_ICONS.length)]}).addTo(map);
    setMarkerHidden(m, !isSpriteZoomVisible(map.getZoom()));
    trees.set(id, {id, marker:m, lat:pt.lat, lng:pt.lng});
  }
}
function spawnRocksBatch(){
  const anchors = getDomAnchors('minehouse'); if(anchors.length===0) return;
  const totalWorkers = getTotalWorkers('minehouse');
  const totalLevel = getTotalHouseLevel('minehouse');
  const ROCK_CAP = (totalWorkers * 10) + (totalLevel * 5) || 50;
  const need = Math.max(0, ROCK_CAP - rocks.size); if(need===0) return;
  const toSpawn = Math.min(6, need);
  for(let i=0;i<toSpawn;i++){
    const anchor = anchors[Math.floor(Math.random()*anchors.length)];
    const pt = pickPointNear(anchor, ROCK_RADIUS_MAX_M, ROCK_RADIUS_MIN_M);
    const id = crypto.randomUUID?.() || Math.random().toString(36).slice(2);
    const m = L.marker([pt.lat, pt.lng], {icon: ROCK_ICONS[Math.floor(Math.random()*ROCK_ICONS.length)]}).addTo(map);
    setMarkerHidden(m, !isSpriteZoomVisible(map.getZoom()));
    rocks.set(id, {id, marker:m, lat:pt.lat, lng:pt.lng});
  }
}
function spawnCornBatch(){
  const anchors = getDomAnchors('fermerdom'); if(anchors.length===0) return;
  const totalWorkers = getTotalWorkers('fermerdom');
  const totalLevel = getTotalHouseLevel('fermerdom');
  const CORN_CAP = (totalWorkers * 10) + (totalLevel * 5) || 50;
  const need = Math.max(0, CORN_CAP - corn.size); if(need===0) return;
  const toSpawn = Math.min(6, need);
  for(let i=0;i<toSpawn;i++){
    const anchor = anchors[Math.floor(Math.random()*anchors.length)];
    const pt = pickPointNear(anchor, CORN_RADIUS_MAX_M, CORN_RADIUS_MIN_M);
    const id = crypto.randomUUID?.() || Math.random().toString(36).slice(2);
    const m = L.marker([pt.lat, pt.lng], {icon: CORN_ICONS[Math.floor(Math.random()*CORN_ICONS.length)]}).addTo(map);
    setMarkerHidden(m, !isSpriteZoomVisible(map.getZoom()));
    corn.set(id, {id, marker:m, lat:pt.lat, lng:pt.lng});
  }
}
/* ====== —Ä–∞–±–æ—á–∏–µ ====== */
const WC_FRAMES = ['./images/Drovosek1.png','./images/Drovosek2.png','./images/Drovosek3.png','./images/Drovosek4.png'];
const MINER_FRAMES= ['./images/Miner1.png','./images/Miner2.png','./images/Miner3.png','./images/Miner4.png'];
const FERM_FRAMES = ['./images/ferma1.png','./images/ferma2.png','./images/ferma3.png','./images/ferma4.png'];
const IDLE_INDEX = 1, FRAME_INTERVAL_MS = 160;
const STEP_SPEED = 0.0009, ARRIVE_EPS = 0.00008;
function makeWorkerDiv(frameUrl, flipped){
  const html = `<div class="worker"><img src="${frameUrl}" class="${flipped?'flip-x':''}" draggable="false"/></div>`;
  return L.divIcon({ html, className:'', iconSize:[48,48], iconAnchor:[24,24] });
}
function nearestTarget(latlng, collectionMap){
  let best=null, bestD=Infinity;
  collectionMap.forEach(t=>{
    const d = Math.abs(t.lat - latlng.lat) + Math.abs(t.lng - latlng.lng);
    if(d<bestD){ best=t; bestD=d; }
  });
  return best;
}
function pickWanderPointAround(homeLatLng){
  const r = randBetween(60,120);
  const ang = Math.random()*2*Math.PI;
  return { lat: homeLatLng.lat + metersToLat(r)*Math.sin(ang),
           lng: homeLatLng.lng + metersToLng(r*Math.cos(ang), homeLatLng.lat) };
}
function createProgressMarker(anchorLatLng){
  const div = document.createElement('div'); div.className = 'progress-wrap';
  const bar = document.createElement('div'); bar.className = 'progress-bar';
  div.appendChild(bar);
  const icon = L.divIcon({ html: div, className:'', iconSize:[64,8], iconAnchor:[32,14] });
  const m = L.marker(anchorLatLng, {icon, interactive:false}).addTo(map);
  setMarkerHidden(m, !isSpriteZoomVisible(map.getZoom()));
  return {marker:m, bar};
}
function createWorker(homeId, type, duration=0){
  const homeMarker = markers.get(homeId); if(!homeMarker) return null;
  const homePos = homeMarker.getLatLng();
  const startAng=Math.random()*2*Math.PI, startR=randBetween(10,25);
  const lat=homePos.lat + metersToLat(startR)*Math.sin(startAng);
  const lng=homePos.lng + metersToLng(startR*Math.cos(startAng), homePos.lat);
  const frames = (type==='wood')?WC_FRAMES:(type==='miner')?MINER_FRAMES:FERM_FRAMES;
  const m=L.marker([lat,lng],{icon: makeWorkerDiv(frames[IDLE_INDEX], false)}).addTo(map);
  setMarkerHidden(m, !isSpriteZoomVisible(map.getZoom()));
  m.worker = { id: Math.random().toString(36).slice(2), type, state:'wander',
    target: pickWanderPointAround(homePos), speed: STEP_SPEED, selected:false, cargo:0,
    harvest:{targetId:null,startTs:0,durationMs:3000,ui:null}, anim:{frameIndex:IDLE_INDEX, accMs:0, facingRight:true},
    homeId, frames, hireEnd: duration > 0 ? Date.now() + duration * 1000 : 0 };
  m.on('click', ()=>{ m.worker.selected = !m.worker.selected; const el=m.getElement();
    if(m.worker.selected){ el?.classList.add('marker-selected'); m.setOpacity(0.9);} else { el?.classList.remove('marker-selected'); m.setOpacity(1);} });
  return m;
}
window.hireWoodcutter = function(homeId){
  const b = buildingData.get(homeId); if(!b || b.owner!==uid || b.type!=='drovosekdom') return;
  const set = woodcuttersByHome.get(homeId) || new Set();
  const max = DROVOSEKDOM_LEVELS[b.level].workers; if(set.size>=max){ showToast(`–õ–∏–º–∏—Ç –¥—Ä–æ–≤–æ—Å–µ–∫–æ–≤ ${set.size}/${max}.`,[],1400); return; }
  const w=createWorker(homeId,'wood'); if(w){ set.add(w); woodcuttersByHome.set(homeId,set); }
  showToast('üë∑ –î—Ä–æ–≤–æ—Å–µ–∫ –Ω–∞–Ω—è—Ç!',[],1200);
  const marker = markers.get(homeId);
  if (marker) marker.bindPopup(makePopupHtml(b));
};
window.hireMiner = function(homeId){
  const b = buildingData.get(homeId); if(!b || b.owner!==uid || b.type!=='minehouse') return;
  const set = minersByHome.get(homeId) || new Set();
  const max = MINEHOUSE_LEVELS[b.level].workers; if(set.size>=max){ showToast(`–õ–∏–º–∏—Ç —à–∞—Ö—Ç—ë—Ä–æ–≤ ${set.size}/${max}.`,[],1400); return; }
  const w=createWorker(homeId,'miner'); if(w){ set.add(w); minersByHome.set(homeId,set); }
  showToast('‚õèÔ∏è –®–∞—Ö—Ç—ë—Ä –Ω–∞–Ω—è—Ç!',[],1200);
  const marker = markers.get(homeId);
  if (marker) marker.bindPopup(makePopupHtml(b));
};
window.hireFermer = function(homeId){
  const b = buildingData.get(homeId); if(!b || b.owner!==uid || b.type==='fermerdom') return;
  const set = farmersByHome.get(homeId) || new Set();
  const max = FERMERVOM_LEVELS[b.level].workers; if(set.size>=max){ showToast(`–õ–∏–º–∏—Ç —Ñ–µ—Ä–º–µ—Ä–æ–≤ ${set.size}/${max}.`,[],1400); return; }
  const w=createWorker(homeId,'fermer'); if(w){ set.add(w); farmersByHome.set(homeId,set); }
  showToast('üöú –§–µ—Ä–º–µ—Ä –Ω–∞–Ω—è—Ç!',[],1200);
  const marker = markers.get(homeId);
  if (marker) marker.bindPopup(makePopupHtml(b));
};
window.hireTemporaryWorker = function(homeId) {
  const b = buildingData.get(homeId);
  if (!b || b.owner !== uid || b.type !== 'houseeat' || resources.food < 2) return;
  const set = (b.type === 'drovosekdom') ? woodcuttersByHome.get(homeId) || new Set() :
              (b.type === 'minehouse') ? minersByHome.get(homeId) || new Set() :
              (b.type === 'fermerdom') ? farmersByHome.get(homeId) || new Set() : new Set();
  const max = (b.type === 'drovosekdom') ? DROVOSEKDOM_LEVELS[b.level].workers :
              (b.type === 'minehouse') ? MINEHOUSE_LEVELS[b.level].workers :
              (b.type === 'fermerdom') ? FERMERVOM_LEVELS[b.level].workers : 0;
  if (set.size >= max) { showToast(`–õ–∏–º–∏—Ç —Ä–∞–±–æ—á–∏—Ö ${set.size}/${max}.`, [], 1400); return; }
  const w = createWorker(homeId, b.type === 'drovosekdom' ? 'wood' : b.type === 'minehouse' ? 'miner' : 'fermer', 5); // 5 minutes
  if (w) {
    set.add(w);
    if (b.type === 'drovosekdom') woodcuttersByHome.set(homeId, set);
    else if (b.type === 'minehouse') minersByHome.set(homeId, set);
    else if (b.type === 'fermerdom') farmersByHome.set(homeId, set);
    resources.food -= 2;
    updateResourcePanel();
    if (uid && playerDocRef) await updateDoc(playerDocRef, { food: resources.food });
    showToast('üë∑ –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ä–∞–±–æ—á–∏–π –Ω–∞–Ω—è—Ç –Ω–∞ 5 –º–∏–Ω—É—Ç!', [], 1200);
    const marker = markers.get(homeId);
    if (marker) marker.bindPopup(makePopupHtml(b));
    setTimeout(() => {
      if (w.worker.hireEnd <= Date.now()) {
        set.delete(w);
        map.removeLayer(w);
        if (marker) marker.bindPopup(makePopupHtml(b));
      }
    }, 300000); // 5 minutes in milliseconds
  }
};
function cookFood(id) {
  const b = buildingData.get(id);
  if (!b || b.owner !== uid || b.type !== 'houseeat' || resources.corn < 5 || resources.money < 50) return;
  resources.corn -= 5;
  resources.money -= 50;
  const levelData = HOUSEEAT_LEVELS[b.level] || HOUSEEAT_LEVELS[1];
  const cookingTime = levelData.foodTime * 1000; // Convert to milliseconds
  showToast(`–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ –µ–¥—ã –Ω–∞—á–∞—Ç–æ! –ì–æ—Ç–æ–≤–æ —á–µ—Ä–µ–∑ ${levelData.foodTime} —Å–µ–∫—É–Ω–¥.`, [], 2000);
  setTimeout(() => {
    resources.food += levelData.foodYield;
    updateResourcePanel();
    if (uid && playerDocRef) updateDoc(playerDocRef, { food: resources.food });
    showToast(`–ì–æ—Ç–æ–≤–æ! +${levelData.foodYield} –µ–¥—ã.`, [], 1500);
  }, cookingTime);
  if (uid && playerDocRef) updateDoc(playerDocRef, { corn: resources.corn, money: resources.money });
}
function startHarvest(workerMarker, targetMap){
  const w = workerMarker.worker; const tgt = targetMap.get(w.harvest.targetId); if(!tgt) return;
  w.harvest.startTs = performance.now(); w.state='harvest'; w.anim.frameIndex=IDLE_INDEX; w.anim.accMs=0;
  workerMarker.setIcon(makeWorkerDiv(w.frames[IDLE_INDEX], !w.anim.facingRight));
  if(w.harvest.ui) map.removeLayer(w.harvest.ui.marker);
  w.harvest.ui = createProgressMarker(workerMarker.getLatLng());
}
function completeHarvest(workerMarker, targetMap, gainMin=2, gainMax=5){
  const w = workerMarker.worker; const tgt = targetMap.get(w.harvest.targetId);
  if(tgt){ map.removeLayer(tgt.marker); targetMap.delete(tgt.id); }
  w.cargo += Math.floor(randBetween(gainMin,gainMax));
  if(w.harvest.ui){ map.removeLayer(w.harvest.ui.marker); w.harvest.ui=null; }
  w.harvest.targetId=null; w.state='return';
}
async function deliverResources(workerMarker){
  const w = workerMarker.worker; if(w.cargo<=0) return;
  if(w.type==='wood'){ resources.wood += w.cargo; showToast(`ü™µ +${w.cargo}`,[],900); }
  else if(w.type==='miner'){ resources.stone += w.cargo; showToast(`ü™® +${w.cargo}`,[],900); }
  else { resources.corn += w.cargo; showToast(`üåΩ +${w.cargo}`,[],900); }
  addXP(w.cargo*2); w.cargo=0; updateResourcePanel();
  if(uid && playerDocRef) await updateDoc(playerDocRef, { wood:resources.wood, stone:resources.stone, corn:resources.corn, level, xp });
}
function updateHarvestUI(workerMarker){
  const w = workerMarker.worker;
  const elapsed = performance.now() - w.harvest.startTs;
  const progress = Math.min(1, elapsed / w.harvest.durationMs);
  if(w.harvest.ui && w.harvest.ui.bar) {
    w.harvest.ui.bar.style.width = (progress * 100) + '%';
  }
  if(elapsed >= w.harvest.durationMs){
    completeHarvest(workerMarker, (w.type==='wood')?trees:(w.type==='miner')?rocks:corn);
  }
}
let __lastTs = performance.now();
function moveWorkers(){
  const now = performance.now(); const dt = now - __lastTs; __lastTs = now;
  function updateSet(set, homeId, type){
    const homeMarker = markers.get(homeId); if(!homeMarker) return;
    const homePos = homeMarker.getLatLng();
    for(const marker of set){
      const w = marker.worker;
      if (w.hireEnd > 0 && w.hireEnd <= Date.now()) {
        set.delete(marker);
        map.removeLayer(marker);
        continue;
      }
      const pos = marker.getLatLng();
      if(w.state==='wander'){
        const pool = (type==='wood')?trees:(type==='miner')?rocks:corn;
        if(pool.size>0){ const nt = nearestTarget(pos, pool); if(nt){ w.state='toTarget'; w.target={lat:nt.lat,lng:nt.lng}; w.harvest.targetId=nt.id; } }
      }
      if(w.state==='toTarget'){
        const pool = (type==='wood')?trees:(type==='miner')?rocks:corn;
        if(!pool.has(w.harvest.targetId)){ w.state='wander'; w.target = pickWanderPointAround(homePos); }
      }
      if(w.state==='harvest') updateHarvestUI(marker);
      let target; if(w.state==='wander' || w.state==='toTarget') target=w.target; else if(w.state==='harvest') target=pos; else target=homePos;
      if(w.state!=='harvest'){
        const dLat=target.lat-pos.lat, dLng=target.lng-pos.lng;
        if(Math.abs(dLng)>1e-8){ const goingRight=dLng>0; if(goingRight!==w.anim.facingRight){ w.anim.facingRight=goingRight; marker.setIcon(makeWorkerDiv(w.frames[w.anim.frameIndex], !w.anim.facingRight)); } }
        if(Math.abs(dLat)+Math.abs(dLng) < ARRIVE_EPS){
          if(w.state==='wander'){
            const pool=(type==='wood')?trees:(type==='miner')?rocks:corn; const nt=nearestTarget(pos,pool);
            if(nt){ w.state='toTarget'; w.target={lat:nt.lat,lng:nt.lng}; w.harvest.targetId=nt.id; } else { w.state='return'; }
          } else if(w.state==='toTarget'){
            const pool=(type==='wood')?trees:(type==='miner')?rocks:corn; const tgt=pool.get(w.harvest.targetId);
            if(tgt){ marker.setLatLng([tgt.lat,tgt.lng]); startHarvest(marker,pool); } else { w.state='wander'; w.target=pickWanderPointAround(homePos); }
          } else if(w.state==='return'){
            deliverResources(marker); w.state='wander'; w.target=pickWanderPointAround(homePos);
          }
        } else {
          marker.setLatLng([pos.lat + dLat*w.speed, pos.lng + dLng*w.speed]);
        }
      }
      const isMoving=(w.state==='wander'||w.state==='toTarget'||w.state==='return');
      if(isMoving){ w.anim.accMs+=dt; if(w.anim.accMs>=FRAME_INTERVAL_MS){ w.anim.accMs=0; w.anim.frameIndex=(w.anim.frameIndex+1)%w.frames.length; marker.setIcon(makeWorkerDiv(w.frames[w.anim.frameIndex], !w.anim.facingRight)); } }
      else if(w.anim.frameIndex!==IDLE_INDEX){ w.anim.frameIndex=IDLE_INDEX; w.anim.accMs=0; marker.setIcon(makeWorkerDiv(w.frames[IDLE_INDEX], !w.anim.facingRight)); }
    }
  }
  woodcuttersByHome.forEach((set,homeId)=>updateSet(set,homeId,'wood'));
  minersByHome.forEach((set,homeId)=>updateSet(set,homeId,'miner'));
  farmersByHome.forEach((set,homeId)=>updateSet(set,homeId,'fermer'));
  requestAnimationFrame(moveWorkers);
}
/* ===== —Ä—ã–Ω–æ–∫ (—Å –∫—É–∫—É—Ä—É–∑–æ–π 10->150) + —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–µ–Ω–µ–≥ ===== */
const overlay = document.getElementById('overlay');
const marketMenu = document.getElementById('marketMenu');
const marketBtn = document.getElementById('marketBtn');
const tabWood = document.getElementById('tabWood');
const tabStone = document.getElementById('tabStone');
const tabCorn = document.getElementById('tabCorn');
const mRate = document.getElementById('m-rate');
const mHave = document.getElementById('m-have');
const mPacks= document.getElementById('m-packs');
const mGet = document.getElementById('m-get');
const mDec = document.getElementById('m-dec');
const mInc = document.getElementById('m-inc');
const mMax = document.getElementById('m-max');
const mSell = document.getElementById('m-sell');
const mCancel=document.getElementById('m-cancel');
const mSellAll = document.getElementById('m-sell-all');
const WOOD_PER_PACK = 10, WOOD_PRICE = 50;
const STONE_PER_PACK = 10, STONE_PRICE = 150;
const CORN_PER_PACK = 10, CORN_PRICE = 150;
let marketResource = 'wood';
function openMarket(){ overlay.style.display='block'; marketMenu.style.display='block'; setMarketResource(marketResource); updateMarketUI(0,true); }
function closeMarket(){ overlay.style.display='none'; marketMenu.style.display='none'; }
marketBtn.onclick = openMarket;
overlay.onclick = closeMarket; mCancel.onclick = closeMarket;
function setMarketResource(res){
  marketResource = res;
  tabWood.classList.toggle('active', res==='wood');
  tabStone.classList.toggle('active', res==='stone');
  tabCorn.classList.toggle('active', res==='corn');
  if(res==='wood'){ mRate.textContent = '10 ü™µ = 50 üí∞'; mHave.textContent = resources.wood; }
  else if(res==='stone'){ mRate.textContent = '10 ü™® = 150 üí∞'; mHave.textContent = resources.stone; }
  else { mRate.textContent = '10 üåΩ = 150 üí∞'; mHave.textContent = resources.corn; }
  updateMarketUI(0,true);
}
tabWood.onclick = ()=>setMarketResource('wood');
tabStone.onclick= ()=>setMarketResource('stone');
tabCorn.onclick = ()=>setMarketResource('corn');
function maxPacks(){ return marketResource==='wood'?Math.floor(resources.wood/WOOD_PER_PACK):marketResource==='stone'?Math.floor(resources.stone/STONE_PER_PACK):Math.floor(resources.corn/CORN_PER_PACK); }
function priceFor(packs){ return marketResource==='wood'?packs*WOOD_PRICE:marketResource==='stone'?packs*STONE_PRICE:packs*CORN_PRICE; }
function updateMarketUI(packs, clamp=false){ const mx=maxPacks(); if(clamp) packs=Math.max(0, Math.min(mx, packs)); mHave.textContent = marketResource==='wood'?resources.wood:marketResource==='stone'?resources.stone:resources.corn; mPacks.textContent=packs; mPacks.dataset.value=packs; mGet.textContent=priceFor(packs); }
function getPacks(){ return parseInt(mPacks.dataset.value||'0',10); }
mDec.onclick = ()=>updateMarketUI(getPacks()-1,true);
mInc.onclick = ()=>updateMarketUI(getPacks()+1,true);
mMax.onclick = ()=>updateMarketUI(9999
