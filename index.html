<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Map Game ‚Äî –ë–∞–∑–∞ —Å –∑–æ–Ω–æ–π, –∞–ø–≥—Ä–µ–π–¥—ã, –¥—Ä–æ–≤–æ—Å–µ–∫–∏ –∏ —à–∞—Ö—Ç—ë—Ä—ã</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
<style>
  :root{ --cream:#F5E6C8; --accent:#ffd56a; }
  html, body {height:100%; margin:0; background:#1e1e1e; color:#eee; font-family:'Segoe UI',sans-serif;}
  #topbar {position:fixed; top:0; left:0; right:0; background:#2b2b2b; z-index:2000; padding:10px; display:flex; flex-wrap:wrap; align-items:center; gap:16px; box-shadow:0 4px 14px rgba(0,0,0,0.4);}
  #map {height:100%; margin-top:88px;}
  button {cursor:pointer; background:#444; color:#eee; border:none; padding:6px 10px; border-radius:8px; font-size:14px;}
  button:hover {background:#666;}
  .small {font-size:12px; color:#aaa;}
  .leaflet-marker-icon, .leaflet-div-icon img {image-rendering: pixelated !important;}
  .pixel {font-family:'Press Start 2P', 'VT323', monospace;}
  #resources {display:flex; flex-wrap:wrap; align-items:center; gap:10px; padding:6px 8px; background:#232323; border:1px solid #3a3a3a; border-radius:10px;}
  .res {display:flex; align-items:center; gap:6px; padding:4px 8px; background:#1a1a1a; border:1px solid #3a3a3a; border-radius:8px;}
  .res b {font-variant-numeric: tabular-nums;}
  #toasts {position:fixed; right:12px; bottom:12px; display:flex; flex-direction:column; gap:8px; z-index:2500;}
  .toast {background:#2d2b2d; border:1px solid #444; border-radius:10px; padding:10px 12px; box-shadow:0 8px 24px rgba(0,0,0,0.35); min-width:280px;}
  .toast .actions {margin-top:8px; display:flex; gap:8px; justify-content:flex-end;}
  .marker-selected {filter: drop-shadow(0 0 6px rgba(0,255,255,0.8));}
  .progress-wrap {background:rgba(0,0,0,0.6); border:1px solid #777; width:64px; height:8px; border-radius:10px; overflow:hidden; transform: translate(-50%,-130%);}
  .progress-bar {height:100%; width:0%; background:#66e089;}
  .worker {width:48px; height:48px; transform: translate(-50%, -50%);}
  .worker img {width:48px; height:48px;}
  .flip-x {transform: scaleX(-1);}
  #editMenu {position:fixed; top:96px; right:10px; background:#2b2b2b; padding:12px; border-radius:12px; display:none; flex-direction:column; gap:8px; z-index:2200; width:340px; box-shadow:0 8px 24px rgba(0,0,0,0.35);}
  #editMenu h4 {margin:0 0 4px 0; font-size:14px;}
  #paintCanvas {image-rendering:pixelated; border:1px solid #555; background:#000; width:480px; height:480px; align-self:center;}
  .colorPalette {display:flex; flex-wrap:wrap; gap:4px; margin-top:4px;}
  .colorTile {width:18px; height:18px; cursor:pointer; border:1px solid #555;}
  #canvasInfo {color:#aaa; font-size:12px;}
  #overlay {position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; z-index:2100;}
  #marketMenu{
    position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
    background:#2b2b2b; border:1px solid #444; border-radius:12px; padding:16px; width:540px; max-width:95vw; z-index:2200;
    box-shadow:0 12px 28px rgba(0,0,0,0.4); display:none;
  }
  #marketMenu h3 {margin:0 0 12px 0;}
  .row {display:flex; align-items:center; justify-content:space-between; gap:10px; margin:8px 0;}
  .tag {background:#1a1a1a; border:1px solid #3a3a3a; border-radius:8px; padding:6px 10px;}
  .num {font-variant-numeric: tabular-nums;}
  .seg {display:flex; gap:6px; align-items:center;}
  .seg button {min-width:36px}
  .actions {display:flex; justify-content:flex-end; gap:8px; margin-top:12px;}
  .tabs {display:flex; gap:8px; margin-bottom:8px;}
  .tabs button {background:#333}
  .tabs .active {background:#555}
  #shopPanel{
    position:fixed; top:88px; left:0; bottom:0; width:330px;
    background:#222; border-right:1px solid #3a3a3a; z-index:2150;
    display:none; overflow-y:auto; padding:12px; box-shadow:8px 0 20px rgba(0,0,0,.35);
  }
  #shopHeader{display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;}
  #shopHeader h3{margin:0}
  .card{
    position:relative; width:300px; height:438px; margin:10px auto;
    image-rendering:pixelated; border-radius:12px; box-shadow:0 10px 18px rgba(0,0,0,.35);
    cursor:pointer; overflow:hidden;
  }
  .card.drov {background:url('C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/CardDrovosek.png') center/cover no-repeat;}
  .card.miner {background:url('C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/CardMiner.png') center/cover no-repeat;}
  .card.base {background:url('C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/CardBase.png') center/cover no-repeat;}
  .card.fermer {background:url('C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Cardeda.png') center/cover no-repeat;}
  .card .title{position:absolute; top:18px; left:84px; right:16px; font-size:13px; color:var(--cream); text-shadow:0 1px 0 #000;}
  .card .cost {position:absolute; top:46px; left:84px; right:16px; font-size:12px; color:var(--cream); text-shadow:0 1px 0 #000;}
  .card .desc {position:absolute; left:30px; right:30px; bottom:22px; font-size:12px; line-height:1.25; color:var(--cream); text-shadow:0 1px 0 #000;}
  .card .buybar{
    position:absolute; top:0; left:0; right:0; height:60px; z-index:3;
    background:linear-gradient(#2b2b2b,#1e1e1e); border-bottom:1px solid #555;
    display:flex; align-items:center; justify-content:center; gap:10px;
    transform:translateY(-100%); transition:transform .25s ease;
  }
  .card.active .buybar{ transform:translateY(0); }
  .buybar .price{font-size:12px; color:var(--accent)}
  .card:hover{filter:brightness(1.07);}
  .is-hidden {opacity:0; pointer-events:none;}
</style>
</head>
<body>

<div id="topbar">
  <div style="min-width:240px"><b>Map Game ‚Äî –ë–∞–∑–∞, –∑–æ–Ω–∞ –∏ –∞–ø–≥—Ä–µ–π–¥—ã</b></div>
  <div id="resources"></div>
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
    <button id="shopToggle">–ú–∞–≥–∞–∑–∏–Ω</button>
    <button id="marketBtn">–†—ã–Ω–æ–∫</button>
    <div class="small">Q ‚Äî –≤—ã–¥–µ–ª–∏—Ç—å —Å–≤–æ–∏ –º–∞—Ä–∫–µ—Ä—ã | Delete ‚Äî —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</div>
  </div>
</div>

<div id="editMenu">
  <h4>–†–µ–¥–∞–∫—Ç–æ—Ä —Å–ø—Ä–∞–π—Ç–∞</h4>
  <canvas id="paintCanvas" width="60" height="60"></canvas>
  <div id="canvasInfo">–õ–æ–≥–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ: 60√ó60</div>
  <div class="colorPalette" id="palette"></div>
  <div style="display:flex; gap:8px; justify-content:flex-end;">
    <button id="saveSprite">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button id="closeEditor">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<div id="overlay"></div>

<div id="marketMenu">
  <h3>–†—ã–Ω–æ–∫</h3>
  <div class="tabs">
    <button id="tabWood" class="active">ü™µ –î–µ—Ä–µ–≤–æ</button>
    <button id="tabStone">ü™® –ö–∞–º–µ–Ω—å</button>
  </div>
  <div class="row">
    <div>–ö—É—Ä—Å: <span id="m-rate" class="tag">10 ü™µ = 50 üí∞</span></div>
    <div>–£ –≤–∞—Å: <span id="m-have" class="num">0</span></div>
  </div>
  <div class="row">
    <div>–ü—Ä–æ–¥–∞—Ç—å –Ω–∞–±–æ—Ä–æ–≤ (–ø–æ 10):</div>
    <div class="seg">
      <button id="m-dec">‚àí1</button>
      <span id="m-packs" class="tag num" style="min-width:48px;text-align:center">0</span>
      <button id="m-inc">+1</button>
      <button id="m-max">MAX</button>
    </div>
  </div>
  <div class="row">
    <div>–ü–æ–ª—É—á–∏—Ç–µ:</div>
    <div><b id="m-get" class="num">0</b> üí∞</div>
  </div>
  <div class="actions">
    <button id="m-cancel">–û—Ç–º–µ–Ω–∞</button>
    <button id="m-sell">–ü—Ä–æ–¥–∞—Ç—å</button>
  </div>
</div>

<aside id="shopPanel">
  <div id="shopHeader">
    <h3 class="pixel">–ú–∞–≥–∞–∑–∏–Ω</h3>
    <button id="shopClose">√ó</button>
  </div>
  <div class="card drov pixel" data-type="drovosekdom" data-cost="100" data-icon="C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/DrovosekDom.png" data-name="DrovosekDom">
    <div class="buybar">
      <span class="price">100 üí∞</span>
      <button class="buyBtn">–ö—É–ø–∏—Ç—å</button>
    </div>
    <div class="title">DrovosekDom</div>
    <div class="cost">–°—Ç–æ–∏–º–æ—Å—Ç—å: 100</div>
    <div class="desc">–î–æ–º –¥—Ä–æ–≤–æ—Å–µ–∫–∞. –†–∞–±–æ—á–∏–µ –¥–æ–±—ã–≤–∞—é—Ç –¥–µ—Ä–µ–≤–æ —Ä—è–¥–æ–º –∏ –Ω–æ—Å—è—Ç –≤ –¥–æ–º.</div>
  </div>
  <div class="card miner pixel" data-type="minehouse" data-cost="100" data-icon="C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Minehouse.png" data-name="Minehouse">
    <div class="buybar">
      <span class="price">100 üí∞</span>
      <button class="buyBtn">–ö—É–ø–∏—Ç—å</button>
    </div>
    <div class="title">Minehouse</div>
    <div class="cost">–°—Ç–æ–∏–º–æ—Å—Ç—å: 100</div>
    <div class="desc">–î–æ–º —à–∞—Ö—Ç—ë—Ä–∞. –ü–æ–±–ª–∏–∑–æ—Å—Ç–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –∫–∞–º–Ω–∏. –®–∞—Ö—Ç—ë—Ä—ã –¥–æ–±—ã–≤–∞—é—Ç –∏ –Ω–µ—Å—É—Ç –≤ –¥–æ–º.</div>
  </div>
  <div class="card base pixel" data-type="base" data-cost="0" data-icon="C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Base.png" data-name="–ë–∞–∑–∞">
    <div class="buybar">
      <span class="price">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
      <button class="buyBtn">–ü–æ—Å—Ç–∞–≤–∏—Ç—å</button>
    </div>
    <div class="title">–ë–∞–∑–∞</div>
    <div class="cost">–°—Ç–æ–∏–º–æ—Å—Ç—å: 0</div>
    <div class="desc">–ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞. –î–∞—Å—Ç —Ü–≤–µ—Ç–Ω—É—é –∑–æ–Ω—É —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ —Å –∞–ø–≥—Ä–µ–π–¥–∞–º–∏.</div>
  </div>
  <!-- –ù–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è Cardeda -->
  <div class="card fermer pixel" data-type="fermerdom" data-cost="100" data-icon="C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/FermerDom.png" data-name="FermerDom">
    <div class="buybar">
      <span class="price">100 üí∞</span>
      <button class="buyBtn">–ö—É–ø–∏—Ç—å</button>
    </div>
    <div class="title">FermerDom</div>
    <div class="cost">–°—Ç–æ–∏–º–æ—Å—Ç—å: 100</div>
    <div class="desc">–î–æ–º —Ñ–µ—Ä–º–µ—Ä–∞. –†–∞–±–æ—á–∏–µ –¥–æ–±—ã–≤–∞—é—Ç –∫—É–∫—É—Ä—É–∑—É —Ä—è–¥–æ–º –∏ –Ω–æ—Å—è—Ç –≤ –¥–æ–º.</div>
  </div>
</aside>

<div id="map"></div>
<div id="toasts"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ===============================
   –ò–ì–†–û–ö –ò –†–ï–°–£–†–°–´
================================ */
function getPlayerId(){
  const key="mapgame_playerId";
  let id=localStorage.getItem(key);
  if(!id){id=Math.random().toString(36).slice(2)+Date.now().toString(36); localStorage.setItem(key,id);}
  return id;
}
const playerId=getPlayerId();

const resources = { money: 100, wood: 10, stone: 0, corn: 0 };
function updateResourcePanel(){
  const el = document.getElementById('resources');
  el.innerHTML = `
    <div class="res">üí∞ –î–µ–Ω—å–≥–∏ <b id="r-money">${resources.money}</b></div>
    <div class="res">ü™µ –î–µ—Ä–µ–≤–æ <b id="r-wood">${resources.wood}</b></div>
    <div class="res">ü™® –ö–∞–º–µ–Ω—å <b id="r-stone">${resources.stone}</b></div>
    <div class="res">üåΩ –ö—É–∫—É—Ä—É–∑–∞ <b id="r-corn">${resources.corn}</b></div>
  `;
}
updateResourcePanel();

/* ===============================
   –ö–ê–†–¢–ê
================================ */
const map = L.map('map').setView([55.751244,37.618423], 5);
L.tileLayer(
  'https://cartodb-basemaps-a.global.ssl.fastly.net/dark_nolabels/{z}/{x}/{y}{r}.png',
  { attribution: '¬©OpenStreetMap ¬©Carto', subdomains: 'abcd', maxZoom: 19 }
).addTo(map);

/* ===============================
   –í–ò–î–ò–ú–û–°–¢–¨ –°–ü–†–ê–ô–¢–û–í –ü–û –ó–£–ú–£
================================ */
const SPRITES_Z_MIN = 11;
function isSpriteZoomVisible(z){ return z >= SPRITES_Z_MIN; }
function setMarkerHidden(m, hidden){
  const el = m?.getElement?.();
  if(el){ if(hidden){ el.classList.add('is-hidden'); } else { el.classList.remove('is-hidden'); } }
  if(hidden && m?.isPopupOpen && m.isPopupOpen()) m.closePopup();
}
function applyVisibilityOnMarker(m){ setMarkerHidden(m, !isSpriteZoomVisible(map.getZoom())); }
function applyVisibilityToAll(){
  const hidden = !isSpriteZoomVisible(map.getZoom());
  markers.forEach(m => setMarkerHidden(m, hidden));
  trees.forEach(t => setMarkerHidden(t.marker, hidden));
  rocks.forEach(r => setMarkerHidden(r.marker, hidden));
  corn.forEach(c => setMarkerHidden(c.marker, hidden));
  woodcuttersByHome.forEach(set => set.forEach(wm => { setMarkerHidden(wm, hidden); const ui=wm.worker.harvest.ui; if(ui?.marker)setMarkerHidden(ui.marker,hidden);} ));
  minersByHome.forEach(set => set.forEach(wm => { setMarkerHidden(wm, hidden); const ui=wm.worker.harvest.ui; if(ui?.marker)setMarkerHidden(ui.marker,hidden);} ));
  farmersByHome.forEach(set => set.forEach(wm => { setMarkerHidden(wm, hidden); const ui=wm.worker.harvest.ui; if(ui?.marker)setMarkerHidden(ui.marker,hidden);} ));
  if(ghostMarker) setMarkerHidden(ghostMarker, hidden);
}
map.on('zoomend', applyVisibilityToAll);

/* ===============================
   –ó–î–ê–ù–ò–Ø / –ë–ê–ó–ê / –ó–û–ù–ê
================================ */
const markers=new Map();
const buildingData=new Map();
const selectedMarkers=new Set();

let baseMarker=null;
let baseZone=null;
let baseMeta={ level:0, color:'#00ffcc', paintSize:32 };

const BASE_LEVELS = {
  1: { radius: 150, icon: 120, cost: 0,    paint: 32  },
  2: { radius: 220, icon: 148, cost: 200,  paint: 64  },
  3: { radius: 300, icon: 176, cost: 500,  paint: 128 },
  4: { radius: 380, icon: 208, cost: 1000, paint: 256 },
};

const DROVOSEKDOM_LEVELS = {
  1: { icon: 96, cost: 150, workers: 3, paint: 60 },
  2: { icon: 112, cost: 350, workers: 5, paint: 72 },
  3: { icon: 128, cost: 650, workers: 9, paint: 84 },
  4: { icon: 144, cost: 1050, workers: 15, paint: 96 },
};

const FERMERVOM_LEVELS = {
  1: { icon: 96, cost: 150, workers: 3, paint: 60 },
  2: { icon: 112, cost: 350, workers: 5, paint: 72 },
  3: { icon: 128, cost: 650, workers: 9, paint: 84 },
  4: { icon: 144, cost: 1050, workers: 15, paint: 96 },
};

function nextBaseCost(){
  if(baseMeta.level>=4) return null;
  return BASE_LEVELS[baseMeta.level+1].cost;
}
function nextDrovosekDomCost(id){
  const b = buildingData.get(id);
  if(!b || b.type !== 'drovosekdom' || b.level >= 4) return null;
  return DROVOSEKDOM_LEVELS[b.level + 1].cost;
}
function nextFermerDomCost(id){
  const b = buildingData.get(id);
  if(!b || b.type !== 'fermerdom' || b.level >= 4) return null;
  return FERMERVOM_LEVELS[b.level + 1].cost;
}
function applyBaseZone(){
  if(!baseMarker) return;
  const lvl = BASE_LEVELS[baseMeta.level];
  if(!lvl) return;
  if(baseZone) baseZone.remove();
  baseZone = L.circle(baseMarker.getLatLng(), {
    radius: lvl.radius,
    color: baseMeta.color,
    weight: 3,
    opacity: 1,
    fillColor: baseMeta.color,
    fillOpacity: 0.15,
    interactive: false
  }).addTo(map);
}
function updateBaseIcon(){
  if(!baseMarker) return;
  const lvl = BASE_LEVELS[baseMeta.level];
  const icon=L.icon({
    iconUrl: 'C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Base.png',
    iconSize:[lvl.icon,lvl.icon],
    iconAnchor:[lvl.icon/2,lvl.icon/2]
  });
  baseMarker.setIcon(icon);
  baseMarker.currentIcon='C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Base.png';
  const b = buildingData.get(baseMarker.options.buildingId);
  if(b) baseMarker.bindPopup(makePopupHtml(b));
}
function updateDrovosekDomIcon(id){
  const marker = markers.get(id);
  if(!marker) return;
  const b = buildingData.get(id);
  if(!b || b.type !== 'drovosekdom') return;
  const lvl = DROVOSEKDOM_LEVELS[b.level];
  const icon = L.icon({
    iconUrl: marker.currentIcon || 'C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/DrovosekDom.png',
    iconSize: [lvl.icon, lvl.icon],
    iconAnchor: [lvl.icon/2, lvl.icon/2]
  });
  marker.setIcon(icon);
  marker.bindPopup(makePopupHtml(b));
}
function updateFermerDomIcon(id){
  const marker = markers.get(id);
  if(!marker) return;
  const b = buildingData.get(id);
  if(!b || b.type !== 'fermerdom') return;
  const lvl = FERMERVOM_LEVELS[b.level];
  const icon = L.icon({
    iconUrl: marker.currentIcon || 'C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/FermerDom.png',
    iconSize: [lvl.icon, lvl.icon],
    iconAnchor: [lvl.icon/2, lvl.icon/2]
  });
  marker.setIcon(icon);
  marker.bindPopup(makePopupHtml(b));
}
function randomBrightColor(){
  const h = Math.floor(Math.random()*360);
  return `hsl(${h} 95% 60%)`;
}
function pointInsideBase(latlng){
  if(!baseMarker || !baseMeta.level) return true;
  const center = baseMarker.getLatLng();
  const dist = map.distance(center, latlng);
  return dist <= BASE_LEVELS[baseMeta.level].radius - 2;
}

const woodcuttersByHome = new Map();
const minersByHome = new Map();
const farmersByHome = new Map();

function generateId(){return Math.random().toString(36).slice(2)+Date.now().toString(36);}

function iconSpecForType(type, level=1){
  if(type==='base'){
    const lvl = BASE_LEVELS[baseMeta.level||1] || BASE_LEVELS[1];
    return {size:[lvl.icon,lvl.icon], anchor:[lvl.icon/2,lvl.icon/2]};
  }
  if(type==='drovosekdom'){
    const lvl = DROVOSEKDOM_LEVELS[level] || DROVOSEKDOM_LEVELS[1];
    return {size:[lvl.icon,lvl.icon], anchor:[lvl.icon/2,lvl.icon/2]};
  }
  if(type==='minehouse') return {size:[96,96], anchor:[48,48]};
  if(type==='fermerdom'){
    const lvl = FERMERVOM_LEVELS[level] || FERMERVOM_LEVELS[1];
    return {size:[lvl.icon,lvl.icon], anchor:[lvl.icon/2,lvl.icon/2]};
  }
  return {size:[64,64], anchor:[32,32]};
}
function iconUrlForType(type, fallback){
  if(type==='base') return 'C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Base.png';
  if(type==='drovosekdom') return 'C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/DrovosekDom.png';
  if(type==='minehouse')   return 'C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Minehouse.png';
  if(type==='fermerdom')   return 'C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/FermerDom.png';
  return fallback || 'C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/House.png';
}
function makePopupHtml(b){
  const owner = b.owner ? b.owner.slice(0,8) : '';
  const name = b.name || b.type;
  const level = b.level || 1;
  const canEdit = (b.owner===playerId);

  const editBtn = canEdit ? `<button onclick="editBuilding('${b.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>` : '';
  const delBtn  = canEdit ? `<button onclick="deleteBuilding('${b.id}')">–£–¥–∞–ª–∏—Ç—å</button>` : '';
  const hireWood = (canEdit && b.type==='drovosekdom') ? `<button onclick="hireWoodcutter('${b.id}')">–ù–∞–Ω—è—Ç—å –¥—Ä–æ–≤–æ—Å–µ–∫–∞</button>` : '';
  const hireMiner= (canEdit && b.type==='minehouse')   ? `<button onclick="hireMiner('${b.id}')">–ù–∞–Ω—è—Ç—å —à–∞—Ö—Ç—ë—Ä–∞</button>` : '';
  const hireFermer = (canEdit && b.type==='fermerdom') ? `<button onclick="hireFermer('${b.id}')">–ù–∞–Ω—è—Ç—å —Ñ–µ—Ä–º–µ—Ä–∞</button>` : '';
  const upgradeBase = (canEdit && b.type==='base')
      ? (()=>{ const cost = nextBaseCost(); return (cost!==null) ? `<button onclick="upgradeBase()">–£–ª—É—á—à–∏—Ç—å –±–∞–∑—É (${cost}üí∞)</button>` : `<span class="small">–ú–∞–∫—Å. —É—Ä–æ–≤–µ–Ω—å</span>`; })()
      : '';
  const upgradeDrovosekDom = (canEdit && b.type==='drovosekdom')
      ? (()=>{ const cost = nextDrovosekDomCost(b.id); return (cost!==null) ? `<button onclick="upgradeDrovosekDom('${b.id}')">–£–ª—É—á—à–∏—Ç—å –¥–æ–º (${cost}üí∞)</button>` : `<span class="small">–ú–∞–∫—Å. —É—Ä–æ–≤–µ–Ω—å</span>`; })()
      : '';
  const upgradeFermerDom = (canEdit && b.type==='fermerdom')
      ? (()=>{ const cost = nextFermerDomCost(b.id); return (cost!==null) ? `<button onclick="upgradeFermerDom('${b.id}')">–£–ª—É—á—à–∏—Ç—å –¥–æ–º (${cost}üí∞)</button>` : `<span class="small">–ú–∞–∫—Å. —É—Ä–æ–≤–µ–Ω—å</span>`; })()
      : '';

  return `üè† <b>${name}</b><br/>–¢–∏–ø: ${b.type}<br/>–£—Ä–æ–≤–µ–Ω—å: ${level}${owner?('<br/>–í–ª–∞–¥–µ–ª–µ—Ü: '+owner):''}<br/>${editBtn} ${delBtn} ${hireWood} ${hireMiner} ${hireFermer} ${upgradeBase} ${upgradeDrovosekDom} ${upgradeFermerDom}`;
}

function addBuildingToMap(b){
  if(!b.id) b.id=generateId();
  if(markers.has(b.id)) return;

  if(!b.level) b.level = 1;

  const spec = iconSpecForType(b.type);
  const iconUrl = iconUrlForType(b.type, b.iconUrl);
  const marker=L.marker([b.lat,b.lng],{icon:L.icon({iconUrl, iconSize:spec.size, iconAnchor:spec.anchor})}).addTo(map);
  applyVisibilityOnMarker(marker);

  marker.options.owner=b.owner; marker.options.buildingId=b.id; marker.currentIcon=iconUrl;
  marker.bindPopup(makePopupHtml(b));

  marker.on('click', ()=>{
    const el=marker.getElement();
    if(selectedMarkers.has(marker)){
      marker.setOpacity(1); selectedMarkers.delete(marker); el?.classList.remove('marker-selected');
    } else if(b.owner===playerId){
      marker.setOpacity(0.7); selectedMarkers.add(marker); el?.classList.add('marker-selected');
    }
  });

  markers.set(b.id,marker);
  buildingData.set(b.id,b);

  if(b.type==='base' && b.owner===playerId){
    baseMarker=marker;
    baseMeta.level = 1;
    baseMeta.color = randomBrightColor();
    baseMeta.paintSize = BASE_LEVELS[1].paint;
    applyBaseZone();
    updateBaseIcon();
  }

  if(b.type==='drovosekdom' && b.owner===playerId && !woodcuttersByHome.has(b.id)) woodcuttersByHome.set(b.id, new Set());
  if(b.type==='minehouse'   && b.owner===playerId && !minersByHome.has(b.id))     minersByHome.set(b.id, new Set());
  if(b.type==='fermerdom' && b.owner===playerId && !farmersByHome.has(b.id)) farmersByHome.set(b.id, new Set());
}

window.deleteBuilding = function(id){
  const marker = markers.get(id); if(!marker) return;
  const b = buildingData.get(id);
  if(!b || b.owner!==playerId) return alert('–ú–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –∑–¥–∞–Ω–∏—è.');
  if(!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∑–¥–∞–Ω–∏–µ?')) return;

  if(b.type==='base'){
    if(baseZone){ baseZone.remove(); baseZone=null; }
    baseMarker=null;
    baseMeta={ level:0, color:randomBrightColor(), paintSize:32 };
  }
  if(b.type==='drovosekdom'){ const set = woodcuttersByHome.get(id); if(set){ set.forEach(w=> map.removeLayer(w)); } woodcuttersByHome.delete(id); }
  if(b.type==='minehouse'){ const set = minersByHome.get(id); if(set){ set.forEach(w=> map.removeLayer(w)); } minersByHome.delete(id); }
  if(b.type==='fermerdom'){ const set = farmersByHome.get(id); if(set){ set.forEach(w=> map.removeLayer(w)); } farmersByHome.delete(id); }

  map.removeLayer(marker);
  markers.delete(id);
  buildingData.delete(id);
};

window.upgradeBase = function(){
  if(!baseMarker) return;
  if(baseMeta.level>=4){ alert('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –±–∞–∑—ã.'); return; }
  const cost = nextBaseCost();
  if(resources.money < cost){ showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥ –¥–ª—è –∞–ø–≥—Ä–µ–π–¥–∞ –±–∞–∑—ã.',[],1600); return; }

  resources.money -= cost; updateResourcePanel();
  baseMeta.level += 1;
  baseMeta.paintSize = BASE_LEVELS[baseMeta.level].paint;
  applyBaseZone();
  updateBaseIcon();
  const b = buildingData.get(baseMarker.options.buildingId);
  if(b) baseMarker.bindPopup(makePopupHtml(b));
  showToast(`–ë–∞–∑–∞ —É–ª—É—á—à–µ–Ω–∞ –¥–æ —É—Ä.${baseMeta.level}!`, [], 1800);
};

window.upgradeDrovosekDom = function(id){
  const marker = markers.get(id);
  if(!marker) return;
  const b = buildingData.get(id);
  if(!b || b.type !== 'drovosekdom' || b.owner !== playerId) return;
  if(b.level >= 4){ alert('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–æ–º–∞ –¥—Ä–æ–≤–æ—Å–µ–∫–∞.'); return; }
  const cost = nextDrovosekDomCost(id);
  if(resources.money < cost){ showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥ –¥–ª—è –∞–ø–≥—Ä–µ–π–¥–∞ –¥–æ–º–∞ –¥—Ä–æ–≤–æ—Å–µ–∫–∞.',[],1600); return; }

  resources.money -= cost; updateResourcePanel();
  b.level += 1;
  updateDrovosekDomIcon(id);
  showToast(`–î–æ–º –¥—Ä–æ–≤–æ—Å–µ–∫–∞ —É–ª—É—á—à–µ–Ω –¥–æ —É—Ä.${b.level}!`, [], 1800);
};

window.upgradeFermerDom = function(id){
  const marker = markers.get(id);
  if(!marker) return;
  const b = buildingData.get(id);
  if(!b || b.type !== 'fermerdom' || b.owner !== playerId) return;
  if(b.level >= 4){ alert('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–æ–º–∞ —Ñ–µ—Ä–º–µ—Ä–∞.'); return; }
  const cost = nextFermerDomCost(id);
  if(resources.money < cost){ showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥ –¥–ª—è –∞–ø–≥—Ä–µ–π–¥–∞ –¥–æ–º–∞ —Ñ–µ—Ä–º–µ—Ä–∞.',[],1600); return; }

  resources.money -= cost; updateResourcePanel();
  b.level += 1;
  updateFermerDomIcon(id);
  showToast(`–î–æ–º —Ñ–µ—Ä–º–µ—Ä–∞ —É–ª—É—á—à–µ–Ω –¥–æ —É—Ä.${b.level}!`, [], 1800);
};

/* ===============================
   –†–ï–î–ê–ö–¢–û–† –°–ü–†–ê–ô–¢–ê
================================ */
const editMenu=document.getElementById('editMenu');
const canvas=document.getElementById('paintCanvas');
const ctx=canvas.getContext('2d');
const paletteDiv=document.getElementById('palette');
const closeEditorBtn=document.getElementById('closeEditor');
const canvasInfo=document.getElementById('canvasInfo');
let editingMarker=null;
let logicalSize=60;

const colors=['#000','#fff','#ff0000','#00ff00','#0000ff','#ffff00','#00ffff','#ff00ff','#888','#444','#ccc','#fa0','#0af','#f0a','#aaa','#555','#222','#111','#333','#666','#999','#b00','#0b0','#00b','#bb0','#0bb','#b0b'];
let currentColor=colors[0];

function setCanvasLogicalSize(s){
  logicalSize = s;
  canvas.width = s; canvas.height = s;
  canvasInfo.textContent = `–õ–æ–≥–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ: ${s}√ó${s}`;
  ctx.imageSmoothingEnabled=false;
}
function drawPixel(x,y){ctx.fillStyle=currentColor; ctx.fillRect(x,y,1,1);}
canvas.addEventListener('mousedown', e=>{
  const rect=canvas.getBoundingClientRect();
  const x=Math.floor((e.clientX-rect.left)*logicalSize/rect.width);
  const y=Math.floor((e.clientY-rect.top)*logicalSize/rect.height);
  drawPixel(x,y);
  const mm=(ev)=>{ const r=canvas.getBoundingClientRect(); const xx=Math.floor((ev.clientX-r.left)*logicalSize/r.width); const yy=Math.floor((ev.clientY-r.top)*logicalSize/r.height); drawPixel(xx,yy); };
  const up=()=>{document.removeEventListener('mousemove',mm); document.removeEventListener('mouseup',up);};
  document.addEventListener('mousemove',mm); document.addEventListener('mouseup',up);
});
paletteDiv.innerHTML=''; colors.forEach(c=>{const d=document.createElement('div'); d.className='colorTile'; d.style.background=c; d.onclick=()=>currentColor=c; paletteDiv.appendChild(d);});

window.editBuilding = function(id){
  const marker=markers.get(id); if(!marker) return;
  editingMarker=marker; editMenu.style.display='flex';
  const b = buildingData.get(id);
  if(b?.type==='base'){ setCanvasLogicalSize(BASE_LEVELS[baseMeta.level].paint); }
  else if(b?.type==='drovosekdom'){ setCanvasLogicalSize(DROVOSEKDOM_LEVELS[b.level].paint); }
  else if(b?.type==='fermerdom'){ setCanvasLogicalSize(FERMERVOM_LEVELS[b.level].paint); }
  else { setCanvasLogicalSize(60); }

  const img=new Image(); img.crossOrigin='anonymous'; img.src=marker.currentIcon;
  img.onload=()=>{ ctx.clearRect(0,0,logicalSize,logicalSize); ctx.drawImage(img,0,0,logicalSize,logicalSize); };
};
document.getElementById('saveSprite').onclick=()=>{
  if(!editingMarker) return;
  const id = editingMarker.options.buildingId;
  const b = buildingData.get(id);
  const dataUrl=canvas.toDataURL();
  const spec = iconSpecForType(b?.type||'', b?.level||1);
  const icon=new L.Icon({iconUrl:dataUrl, iconSize:spec.size, iconAnchor:spec.anchor});
  editingMarker.setIcon(icon);
  editingMarker.currentIcon=dataUrl;
  if(b) editingMarker.bindPopup(makePopupHtml(b));
  editMenu.style.display='none'; editingMarker=null;
};
closeEditorBtn.onclick=()=>{ editMenu.style.display='none'; editingMarker=null; };

/* ===============================
   –†–ï–°–£–†–°–ù–´–ï –û–ë–™–ï–ö–¢–´ (–¥–µ—Ä–µ–≤—å—è/–∫–∞–º–Ω–∏/–∫—É–∫—É—Ä—É–∑–∞)
================================ */
const TREE_ICONS = [
  new L.Icon({iconUrl:'C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Tree1.png', iconSize:[48,48], iconAnchor:[24,36]}),
  new L.Icon({iconUrl:'C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Tree2.png', iconSize:[48,48], iconAnchor:[24,36]}),
  new L.Icon({iconUrl:'C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Tree3.png', iconSize:[48,48], iconAnchor:[24,36]}),
];
const trees = new Map();
const TREE_CAP = 50, TREE_SPAWN_INTERVAL_MS = 60_000, TREE_RADIUS_MAX_M = 100, TREE_RADIUS_MIN_M = 20;

const ROCK_ICONS = [
  new L.Icon({iconUrl:'C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Kamen.png',  iconSize:[48,48], iconAnchor:[24,36]}),
  new L.Icon({iconUrl:'C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Kamen2.png', iconSize:[48,48], iconAnchor:[24,36]}),
  new L.Icon({iconUrl:'C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Kamen3.png', iconSize:[48,48], iconAnchor:[24,36]}),
];
const rocks = new Map();
const ROCK_CAP = 50, ROCK_SPAWN_INTERVAL_MS = 60_000, ROCK_RADIUS_MAX_M = 100, ROCK_RADIUS_MIN_M = 20;

const CORN_ICONS = [
  new L.Icon({iconUrl:'C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Corn.png',  iconSize:[48,48], iconAnchor:[24,36]}),
  new L.Icon({iconUrl:'C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Corn2.png', iconSize:[48,48], iconAnchor:[24,36]}),
  new L.Icon({iconUrl:'C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Corn3.png', iconSize:[48,48], iconAnchor:[24,36]}),
];
const corn = new Map();
const CORN_CAP = 50, CORN_SPAWN_INTERVAL_MS = 60_000, CORN_RADIUS_MAX_M = 100, CORN_RADIUS_MIN_M = 20;

function metersToLat(deltaM){ return deltaM/111000; }
function randBetween(a,b){ return a + Math.random()*(b-a); }
function pickPointNear(latlng, maxM, minM){
  const r = randBetween(minM, maxM);
  const ang = Math.random()*2*Math.PI;
  return { lat: latlng.lat + metersToLat(r)*Math.sin(ang),
           lng: latlng.lng + metersToLat(r)*Math.cos(ang) };
}
function getDomAnchors(type){
  const anchors=[];
  buildingData.forEach((b,id)=>{ if(b.type===type){ const m=markers.get(id); if(m) anchors.push(m.getLatLng()); } });
  return anchors;
}
function spawnTreesBatch(){
  const anchors = getDomAnchors('drovosekdom');
  if(anchors.length===0) return;
  const need = Math.max(0, TREE_CAP - trees.size); if(need===0) return;
  const toSpawn = Math.min(6, need);
  for(let i=0;i<toSpawn;i++){
    const anchor = anchors[Math.floor(Math.random()*anchors.length)];
    const pt = pickPointNear(anchor, TREE_RADIUS_MAX_M, TREE_RADIUS_MIN_M);
    const id = generateId();
    const m = L.marker([pt.lat, pt.lng], {icon: TREE_ICONS[Math.floor(Math.random()*TREE_ICONS.length)]}).addTo(map);
    applyVisibilityOnMarker(m);
    trees.set(id, {id, marker:m, lat:pt.lat, lng:pt.lng});
  }
}
function spawnRocksBatch(){
  const anchors = getDomAnchors('minehouse');
  if(anchors.length===0) return;
  const need = Math.max(0, ROCK_CAP - rocks.size); if(need===0) return;
  const toSpawn = Math.min(6, need);
  for(let i=0;i<toSpawn;i++){
    const anchor = anchors[Math.floor(Math.random()*anchors.length)];
    const pt = pickPointNear(anchor, ROCK_RADIUS_MAX_M, ROCK_RADIUS_MIN_M);
    const id = generateId();
    const m = L.marker([pt.lat, pt.lng], {icon: ROCK_ICONS[Math.floor(Math.random()*ROCK_ICONS.length)]}).addTo(map);
    applyVisibilityOnMarker(m);
    rocks.set(id, {id, marker:m, lat:pt.lat, lng:pt.lng});
  }
}
function spawnCornBatch(){
  const anchors = getDomAnchors('fermerdom');
  if(anchors.length===0) return;
  const need = Math.max(0, CORN_CAP - corn.size); if(need===0) return;
  const toSpawn = Math.min(6, need);
  for(let i=0;i<toSpawn;i++){
    const anchor = anchors[Math.floor(Math.random()*anchors.length)];
    const pt = pickPointNear(anchor, CORN_RADIUS_MAX_M, CORN_RADIUS_MIN_M);
    const id = generateId();
    const m = L.marker([pt.lat, pt.lng], {icon: CORN_ICONS[Math.floor(Math.random()*CORN_ICONS.length)]}).addTo(map);
    applyVisibilityOnMarker(m);
    corn.set(id, {id, marker:m, lat:pt.lat, lng:pt.lng});
  }
}

/* ===============================
   –†–ê–ë–û–ß–ò–ï (–¥—Ä–æ–≤–æ—Å–µ–∫–∏ / —à–∞—Ö—Ç—ë—Ä—ã / —Ñ–µ—Ä–º–µ—Ä—ã)
================================ */
const WC_FRAMES = ['C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Drovosek1.png','C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Drovosek2.png','C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Drovosek3.png','C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Drovosek4.png'];
const MINER_FRAMES = ['C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Miner1.png','C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Miner2.png','C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Miner3.png','C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/Miner4.png'];
const FERM_FRAMES = ['C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/ferma1.png','C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/ferma2.png','C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/ferma3.png','C:/Users/novik/OneDrive/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/map-game/public/images/ferma4.png'];
const IDLE_INDEX = 1, FRAME_INTERVAL_MS = 160;
const STEP_SPEED = 0.0009, ARRIVE_EPS = 0.00008;

function makeWorkerDiv(frameUrl, flipped){
  const html = `<div class="worker"><img src="${frameUrl}" class="${flipped?'flip-x':''}" draggable="false"/></div>`;
  return L.divIcon({ html, className:'', iconSize:[48,48], iconAnchor:[24,24] });
}
function nearestTarget(latlng, collectionMap){
  let best=null, bestD=Infinity;
  collectionMap.forEach(t=>{
    const d = Math.abs(t.lat - latlng.lat) + Math.abs(t.lng - latlng.lng);
    if(d<bestD){ best=t; bestD=d; }
  });
  return best;
}
function pickWanderPointAround(homeLatLng){
  const r = randBetween(60,120);
  const ang = Math.random()*2*Math.PI;
  return { lat: homeLatLng.lat + metersToLat(r)*Math.sin(ang),
           lng: homeLatLng.lng + metersToLat(r)*Math.cos(ang) };
}
function createProgressMarker(anchorLatLng){
  const div = document.createElement('div'); div.className = 'progress-wrap';
  const bar = document.createElement('div'); bar.className = 'progress-bar';
  div.appendChild(bar);
  const icon = L.divIcon({ html: div, className:'', iconSize:[64,8], iconAnchor:[32,14] });
  const m = L.marker(anchorLatLng, {icon, interactive:false}).addTo(map);
  applyVisibilityOnMarker(m);
  return {marker:m, bar};
}
function createWorker(homeId, type){
  const homeMarker = markers.get(homeId); if(!homeMarker) return null;
  const homePos = homeMarker.getLatLng();

  const startAng=Math.random()*2*Math.PI, startR=randBetween(10,25);
  const lat=homePos.lat + metersToLat(startR)*Math.sin(startAng);
  const lng=homePos.lng + metersToLat(startR)*Math.cos(startAng);

  let frames;
  if(type==='wood') frames = WC_FRAMES;
  else if(type==='miner') frames = MINER_FRAMES;
  else if(type==='fermer') frames = FERM_FRAMES;

  const m=L.marker([lat,lng],{icon: makeWorkerDiv(frames[IDLE_INDEX], false)}).addTo(map);
  applyVisibilityOnMarker(m);
  m.worker = {
    id: generateId(),
    type, // wood | miner | fermer
    state:'wander',
    target: pickWanderPointAround(homePos),
    speed: STEP_SPEED,
    selected:false,
    cargo: 0,
    harvest: { targetId:null, startTs:0, durationMs:3000, ui:null },
    anim: { frameIndex: IDLE_INDEX, accMs: 0, facingRight: true },
    homeId: homeId,
    frames: frames
  };

  m.on('click', ()=>{
    m.worker.selected = !m.worker.selected;
    const el = m.getElement();
    if(m.worker.selected){ el?.classList.add('marker-selected'); m.setOpacity(0.9);}
    else { el?.classList.remove('marker-selected'); m.setOpacity(1); }
  });
  return m;
}
window.hireWoodcutter = function(homeId){
  const b = buildingData.get(homeId);
  if(!b || b.owner!==playerId || b.type!=='drovosekdom') return;
  const set = woodcuttersByHome.get(homeId) || new Set();
  const maxWorkers = DROVOSEKDOM_LEVELS[b.level].workers;
  if(set.size >= maxWorkers){ showToast(`–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –¥—Ä–æ–≤–æ—Å–µ–∫–æ–≤ (${maxWorkers}) –¥–ª—è —É—Ä–æ–≤–Ω—è ${b.level}.`, [], 1500); return; }
  const w = createWorker(homeId,'wood'); if(w){ set.add(w); woodcuttersByHome.set(homeId,set); }
  showToast('üë∑ –î—Ä–æ–≤–æ—Å–µ–∫ –Ω–∞–Ω—è—Ç!', [], 1500);
};
window.hireMiner = function(homeId){
  const b = buildingData.get(homeId);
  if(!b || b.owner!==playerId || b.type!=='minehouse') return;
  const set = minersByHome.get(homeId) || new Set();
  const w = createWorker(homeId,'miner'); if(w){ set.add(w); minersByHome.set(homeId,set); }
  showToast('‚õèÔ∏è –®–∞—Ö—Ç—ë—Ä –Ω–∞–Ω—è—Ç!', [], 1500);
};
window.hireFermer = function(homeId){
  const b = buildingData.get(homeId);
  if(!b || b.owner!==playerId || b.type!=='fermerdom') return;
  const set = farmersByHome.get(homeId) || new Set();
  const maxWorkers = FERMERVOM_LEVELS[b.level].workers;
  if(set.size >= maxWorkers){ showToast(`–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç —Ñ–µ—Ä–º–µ—Ä–æ–≤ (${maxWorkers}) –¥–ª—è —É—Ä–æ–≤–Ω—è ${b.level}.`, [], 1500); return; }
  const w = createWorker(homeId,'fermer'); if(w){ set.add(w); farmersByHome.set(homeId,set); }
  showToast('üöú –§–µ—Ä–º–µ—Ä –Ω–∞–Ω—è—Ç!', [], 1500);
};
function startHarvest(workerMarker, targetMap){
  const w = workerMarker.worker;
  const tgt = targetMap.get(w.harvest.targetId);
  if(!tgt) return;
  w.harvest.startTs = performance.now();
  w.state = 'harvest';
  w.anim.frameIndex = IDLE_INDEX; w.anim.accMs = 0;
  workerMarker.setIcon(makeWorkerDiv(w.frames[IDLE_INDEX], !w.anim.facingRight));
  if(w.harvest.ui) map.removeLayer(w.harvest.ui.marker);
  w.harvest.ui = createProgressMarker(workerMarker.getLatLng());
}
function completeHarvest(workerMarker, targetMap, gainMin=2, gainMax=5){
  const w = workerMarker.worker;
  const tgt = targetMap.get(w.harvest.targetId);
  if(tgt){ map.removeLayer(tgt.marker); targetMap.delete(tgt.id); }
  const gained = Math.floor(randBetween(gainMin,gainMax));
  w.cargo += gained;
  if(w.harvest.ui){ map.removeLayer(w.harvest.ui.marker); w.harvest.ui=null; }
  w.harvest.targetId = null;
  w.state='return';
}
function updateHarvestUI(workerMarker){
  const w = workerMarker.worker; if(!w.harvest.ui) return;
  const t = performance.now();
  const p = Math.min(1, (t - w.harvest.startTs)/w.harvest.durationMs);
  w.harvest.ui.bar.style.width = (p*100).toFixed(0)+'%';
  w.harvest.ui.marker.setLatLng(workerMarker.getLatLng());
  if(p>=1){
    let targetMap;
    if(w.type==='wood') targetMap = trees;
    else if(w.type==='miner') targetMap = rocks;
    else if(w.type==='fermer') targetMap = corn;
    completeHarvest(workerMarker, targetMap, 2,5);
  }
}
function deliverResources(workerMarker){
  const w = workerMarker.worker;
  const homeMarker = markers.get(w.homeId); if(!homeMarker) return;
  if(w.cargo>0){
    if(w.type==='wood'){ resources.wood += w.cargo; showToast(`ü™µ –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: ${w.cargo}`,[],1500); }
    else if(w.type==='miner'){ resources.stone += w.cargo; showToast(`ü™® –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: ${w.cargo}`,[],1500); }
    else if(w.type==='fermer'){ resources.corn += w.cargo; showToast(`üåΩ –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: ${w.cargo}`,[],1500); }
    w.cargo = 0; updateResourcePanel();
  }
}
let __lastTs = performance.now();
function moveWorkers(){
  const now = performance.now();
  const dt = now - __lastTs; __lastTs = now;

  function updateSet(set, homeId, type){
    const homeMarker = markers.get(homeId); if(!homeMarker) return;
    const homePos = homeMarker.getLatLng();

    for(const marker of set){
      const w=marker.worker;
      const pos=marker.getLatLng();

      if(w.state==='wander'){
        let pool;
        if(type==='wood') pool = trees;
        else if(type==='miner') pool = rocks;
        else if(type==='fermer') pool = corn;
        if(pool.size>0){
          const nt = nearestTarget(pos, pool);
          if(nt){ w.state='toTarget'; w.target={lat:nt.lat,lng:nt.lng}; w.harvest.targetId=nt.id; }
        }
      }
      if(w.state==='toTarget'){
        let pool;
        if(type==='wood') pool = trees;
        else if(type==='miner') pool = rocks;
        else if(type==='fermer') pool = corn;
        if(!pool.has(w.harvest.targetId)){
          w.state='wander'; w.target = pickWanderPointAround(homePos);
        }
      }
      if(w.state==='harvest') updateHarvestUI(marker);

      let target;
      if(w.state==='wander' || w.state==='toTarget') target = w.target;
      else if(w.state==='harvest') target = pos;
      else if(w.state==='return') target = homePos;

      if(w.state!=='harvest'){
        const dLat = target.lat - pos.lat;
        const dLng = target.lng - pos.lng;

        if(Math.abs(dLng) > 1e-8){
          const goingRight = dLng > 0;
          if(goingRight !== w.anim.facingRight){
            w.anim.facingRight = goingRight;
            marker.setIcon(makeWorkerDiv(w.frames[w.anim.frameIndex], !w.anim.facingRight));
          }
        }

        if(Math.abs(dLat)+Math.abs(dLng) < ARRIVE_EPS){
          if(w.state==='wander'){
            let pool;
            if(type==='wood') pool = trees;
            else if(type==='miner') pool = rocks;
            else if(type==='fermer') pool = corn;
            const nt = nearestTarget(pos, pool);
            if(nt){ w.state='toTarget'; w.target={lat:nt.lat,lng:nt.lng}; w.harvest.targetId=nt.id; }
            else { w.state='return'; }
          } else if(w.state==='toTarget'){
            let pool;
            if(type==='wood') pool = trees;
            else if(type==='miner') pool = rocks;
            else if(type==='fermer') pool = corn;
            const tgt = pool.get(w.harvest.targetId);
            if(tgt){ marker.setLatLng([tgt.lat, tgt.lng]); startHarvest(marker, pool); }
            else { w.state='wander'; w.target = pickWanderPointAround(homePos); }
          } else if(w.state==='return'){
            deliverResources(marker);
            w.state='wander'; w.target = pickWanderPointAround(homePos);
          }
        } else {
          marker.setLatLng([pos.lat + dLat*w.speed, pos.lng + dLng*w.speed]);
        }
      }

      const isMoving = (w.state==='wander' || w.state==='toTarget' || w.state==='return');
      if(isMoving){
        w.anim.accMs += dt;
        if(w.anim.accMs >= FRAME_INTERVAL_MS){
          w.anim.accMs = 0;
          w.anim.frameIndex = (w.anim.frameIndex + 1) % w.frames.length;
          marker.setIcon(makeWorkerDiv(w.frames[w.anim.frameIndex], !w.anim.facingRight));
        }
      } else if(w.anim.frameIndex !== IDLE_INDEX){
        w.anim.frameIndex = IDLE_INDEX; w.anim.accMs = 0;
        marker.setIcon(makeWorkerDiv(w.frames[IDLE_INDEX], !w.anim.facingRight));
      }
    }
  }

  woodcuttersByHome.forEach((set, homeId)=>updateSet(set, homeId, 'wood'));
  minersByHome.forEach((set, homeId)=>updateSet(set, homeId, 'miner'));
  farmersByHome.forEach((set, homeId)=>updateSet(set, homeId, 'fermer'));

  requestAnimationFrame(moveWorkers);
}

/* ===============================
   –†–´–ù–û–ö
================================ */
const overlay = document.getElementById('overlay');
const marketMenu = document.getElementById('marketMenu');
const marketBtn = document.getElementById('marketBtn');
const tabWood = document.getElementById('tabWood');
const tabStone= document.getElementById('tabStone');

const mRate = document.getElementById('m-rate');
const mHave = document.getElementById('m-have');
const mPacks = document.getElementById('m-packs');
const mGet = document.getElementById('m-get');
const mDec = document.getElementById('m-dec');
const mInc = document.getElementById('m-inc');
const mMax = document.getElementById('m-max');
const mSell = document.getElementById('m-sell');
const mCancel = document.getElementById('m-cancel');

const WOOD_PER_PACK = 10, WOOD_PRICE = 50;
const STONE_PER_PACK = 10, STONE_PRICE = 150;
let marketResource = 'wood';

function openMarket(){ overlay.style.display='block'; marketMenu.style.display='block'; setMarketResource('wood'); updateMarketUI(0,true); }
function closeMarket(){ overlay.style.display='none'; marketMenu.style.display='none'; }
marketBtn.onclick = openMarket; overlay.onclick = closeMarket; mCancel.onclick = closeMarket;

function setMarketResource(res){
  marketResource = res;
  tabWood.classList.toggle('active', res==='wood');
  tabStone.classList.toggle('active', res==='stone');
  if(res==='wood'){ mRate.textContent = '10 ü™µ = 50 üí∞'; mHave.textContent = resources.wood.toString(); }
  else{ mRate.textContent = '10 ü™® = 150 üí∞'; mHave.textContent = resources.stone.toString(); }
  updateMarketUI(0,true);
}
tabWood.onclick = ()=>setMarketResource('wood');
tabStone.onclick = ()=>setMarketResource('stone');

function maxPacksFor(res){ return res==='wood' ? Math.floor(resources.wood/WOOD_PER_PACK) : Math.floor(resources.stone/STONE_PER_PACK); }
function moneyForPacks(res, packs){ return res==='wood' ? packs*WOOD_PRICE : packs*STONE_PRICE; }
function updateMarketUI(packs, clamp=false){
  const max = maxPacksFor(marketResource); if(clamp) packs = Math.max(0, Math.min(max, packs));
  mHave.textContent = (marketResource==='wood'?resources.wood:resources.stone);
  mPacks.textContent = packs.toString(); mPacks.dataset.value = packs.toString();
  mGet.textContent = moneyForPacks(marketResource, packs).toString();
}
function getPacks(){ return parseInt(mPacks.dataset.value||'0',10); }
mDec.onclick = ()=>updateMarketUI(getPacks()-1,true);
mInc.onclick = ()=>updateMarketUI(getPacks()+1,true);
mMax.onclick = ()=>updateMarketUI(9999,true);
mSell.onclick = ()=>{
  const packs = getPacks(); if(packs<=0) return;
  if(marketResource==='wood'){ const need=packs*WOOD_PER_PACK; if(resources.wood<need) return showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ—Ä–µ–≤–∞',[],1500); resources.wood-=need; resources.money+=packs*WOOD_PRICE; }
  else { const need=packs*STONE_PER_PACK; if(resources.stone<need) return showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–∞–º–Ω—è',[],1500); resources.stone-=need; resources.money+=packs*STONE_PRICE; }
  updateResourcePanel(); showToast('–°–¥–µ–ª–∫–∞ —Å–æ–≤–µ—Ä—à–µ–Ω–∞!',[],1200); closeMarket();
};

/* ===============================
   –ú–ê–ì–ê–ó–ò–ù (–ø–∞–Ω–µ–ª—å + ¬´–ø—Ä–∏–∑—Ä–∞–∫¬ª) –∏ –ü–û–ö–£–ü–ö–ò
================================ */
const shopPanel = document.getElementById('shopPanel');
const shopToggle = document.getElementById('shopToggle');
const shopClose = document.getElementById('shopClose');

let placementMode = { active:false, blueprint:null };
let ghostMarker = null;

shopToggle.onclick = ()=> shopPanel.style.display = (shopPanel.style.display==='block'?'none':'block');
shopClose.onclick  = ()=> shopPanel.style.display = 'none';

shopPanel.querySelectorAll('.card').forEach(card=>{
  card.addEventListener('click', (e)=>{
    shopPanel.querySelectorAll('.card').forEach(c=>{ if(c!==card) c.classList.remove('active'); });
    card.classList.toggle('active'); e.stopPropagation();
  });
});
shopPanel.querySelectorAll('.buyBtn').forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    e.stopPropagation();
    const card = btn.closest('.card');
    const bp = { type: card.dataset.type, cost: parseInt(card.dataset.cost,10)||0, iconUrl: card.dataset.icon, name: card.dataset.name };
    if(resources.money < bp.cost){ showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥ –¥–ª—è –ø–æ–∫—É–ø–∫–∏.', [], 1800); return; }
    placementMode = { active:true, blueprint:bp };
    makeGhostForBlueprint(bp);
    shopPanel.style.display='none';
    showToast('–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ –≤ –∑–æ–Ω–µ –±–∞–∑—ã –∏ –∫–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å –∑–¥–∞–Ω–∏–µ.', [], 2200);
  });
});

function makeGhostForBlueprint(bp){
  removeGhost();
  const spec = iconSpecForType(bp.type);
  const icon = L.icon({iconUrl: bp.iconUrl, iconSize: spec.size, iconAnchor: spec.anchor});
  ghostMarker = L.marker(map.getCenter(), {icon, interactive:false, opacity:0.6}).addTo(map);
  applyVisibilityOnMarker(ghostMarker);
  map.on('mousemove', ghostFollow);
}
function ghostFollow(e){ if(ghostMarker) ghostMarker.setLatLng(e.latlng); }
function removeGhost(){ if(ghostMarker){ map.removeLayer(ghostMarker); ghostMarker=null; } map.off('mousemove', ghostFollow); }

map.on('click', e=>{
  if(!placementMode.active) return;
  const bp = placementMode.blueprint;

  if(bp.type!=='base' && !pointInsideBase(e.latlng)){ showToast('–°—Ç—Ä–æ–∏—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –≤ –∑–æ–Ω–µ –≤–∞—à–µ–π –±–∞–∑—ã.', [], 2000); return; }

  if(bp.cost>0){ resources.money -= bp.cost; updateResourcePanel(); }
  addBuildingToMap({ id:generateId(), lat:e.latlng.lat, lng:e.latlng.lng, type:bp.type, owner:playerId, name:bp.name });

  placementMode = {active:false, blueprint:null};
  removeGhost();
});

/* ===============================
   –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
================================ */
spawnTreesBatch(); spawnRocksBatch(); spawnCornBatch();
requestAnimationFrame(moveWorkers);
setInterval(spawnTreesBatch, TREE_SPAWN_INTERVAL_MS);
setInterval(spawnRocksBatch, ROCK_SPAWN_INTERVAL_MS);
setInterval(spawnCornBatch, CORN_SPAWN_INTERVAL_MS);
applyVisibilityToAll();

/* –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ */
document.addEventListener('keydown', e=>{
  if(e.key==='q'||e.key==='Q'){
    selectedMarkers.forEach(m=>{ m.setOpacity(1); m.getElement()?.classList.remove('marker-selected'); });
    selectedMarkers.clear();
    markers.forEach(marker=>{
      if(marker.options.owner===playerId){
        marker.setOpacity(0.7); selectedMarkers.add(marker); marker.getElement()?.classList.add('marker-selected');
      }
    });
  }
  if(e.key==='Delete'){
    selectedMarkers.forEach(marker=>{
      const id = marker.options.buildingId;
      const b = buildingData.get(id);
      if(b && b.owner===playerId) window.deleteBuilding(id);
    });
    selectedMarkers.clear();
  }
});

/* –¢–æ—Å—Ç—ã */
const toasts=document.getElementById('toasts');
function showToast(html, actions=[] , timeoutMs=0){
  const t=document.createElement('div'); t.className='toast'; t.innerHTML=html;
  if(actions.length){
    const row=document.createElement('div'); row.className='actions';
    actions.forEach(a=>{ const btn=document.createElement('button'); btn.textContent=a.text; btn.onclick=()=>{ try{a.onClick?.();} finally{toasts.removeChild(t);} }; row.appendChild(btn); });
    t.appendChild(row);
  }
  toasts.appendChild(t);
  if(timeoutMs>0){ setTimeout(()=>{ if(t.parentNode) toasts.removeChild(t); }, timeoutMs); }
}
</script>
</body>
</html>
